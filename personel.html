<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personel Panel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; background:#f3f4f6; padding:20px; }
.card { background:#fff; padding:16px; border-radius:14px; margin-bottom:14px; }
input, select, button { padding:8px; border-radius:8px; border:1px solid #ccc; }
button { cursor:pointer; }
.primary { background:#16a34a; color:white; border:none; }
.danger { background:#dc2626; color:white; border:none; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px; border-bottom:1px solid #eee; font-size:14px; }
th { background:#f9fafb; }
</style>
</head>
<body>

<h2>üë∑ Personel Panel</h2>

<div id="loginBox" class="card">
<h3>Giri≈ü</h3>
<input type="text" id="username" placeholder="Ad Soyad"><br><br>
<input type="password" id="password" placeholder="≈ûifre"><br><br>
<button class="primary" onclick="login()">Giri≈ü Yap</button>
</div>

<div id="panelBox" style="display:none;">

<div class="card">
<h3>Hareket Ekle</h3>

<p><b>Kullanƒ±cƒ±:</b> <span id="aktifKullanici"></span></p>

<select id="tur">
<option value="giris">Giri≈ü</option>
<option value="cikis">√áƒ±kƒ±≈ü</option>
<option value="izin">ƒ∞zin</option>
<option value="not">Not</option>
</select><br><br>

<input type="text" id="notText" placeholder="Not (isteƒüe baƒülƒ±)"><br><br>

<button class="primary" onclick="kaydet()">Kaydet</button>
<button class="danger" onclick="cikis()">√áƒ±kƒ±≈ü</button>

<p id="mesaj"></p>
</div>

<div class="card">
<h3>Kayƒ±tlarƒ±m</h3>

Ba≈ülangƒ±√ß:
<input type="date" id="dtStart">
Biti≈ü:
<input type="date" id="dtEnd">
<button onclick="loadData()">Filtrele</button>

<br><br>
<input type="text" id="txtSearch" placeholder="üîé Ara..." style="width:100%;">

<table style="margin-top:10px;">
<thead>
<tr>
<th>Tarih</th>
<th>Saat</th>
<th>T√ºr</th>
<th>Not</th>
<th>D√ºzelt</th>
</tr>
</thead>
<tbody id="dataTable">
<tr><td colspan="5">Y√ºkleniyor...</td></tr>
</tbody>
</table>

</div>

</div>

<script>

const SUPABASE_URL = "https://ngnpocqaznpuggsvwbif.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

let aktif = null;
let currentData = [];

window.onload = function(){
  const saved = localStorage.getItem("aktifKullanici");
  if(saved){
    aktif = saved;
    aktifKullanici.innerText = aktif;
    loginBox.style.display="none";
    panelBox.style.display="block";
    setDefaultDates();
    loadData();
  }
};

function setDefaultDates(){
  const today = new Date();
  const past = new Date();
  past.setDate(today.getDate()-3);

  dtStart.value = past.toISOString().split("T")[0];
  dtEnd.value = today.toISOString().split("T")[0];
}

async function login(){

  const kullanici = username.value.trim();
  const sifre = password.value.trim();

  const { data } = await supabaseClient
    .from("personeller")
    .select("*")
    .eq("ad_soyad", kullanici)
    .eq("sifre", sifre)
    .single();

  if(!data){
    alert("Hatalƒ± giri≈ü");
    return;
  }

  aktif = kullanici;
  localStorage.setItem("aktifKullanici", kullanici);

  aktifKullanici.innerText = aktif;
  loginBox.style.display="none";
  panelBox.style.display="block";

  setDefaultDates();
  loadData();
}

async function kaydet(){

  const { error } = await supabaseClient
    .from("hareketler")
    .insert([{
      personel_id: aktif,
      tur: tur.value,
      not_text: notText.value.trim()
    }]);

  if(error){
    mesaj.innerText="Hata olu≈ütu";
    mesaj.style.color="red";
    return;
  }

  mesaj.innerText="Kaydedildi ‚úî";
  mesaj.style.color="green";
  notText.value="";
  loadData();
}

async function loadData(){

  const start = dtStart.value + "T00:00:00";
  const end = dtEnd.value + "T23:59:59";

  const { data } = await supabaseClient
    .from("hareketler")
    .select("*")
    .eq("personel_id", aktif)
    .gte("created_at", start)
    .lte("created_at", end)
    .order("created_at",{ascending:false})
    .limit(100);

  currentData = data || [];
  renderTable(currentData);
}

function renderTable(data){

  dataTable.innerHTML="";

  if(!data.length){
    dataTable.innerHTML=`<tr><td colspan="5">Kayƒ±t yok</td></tr>`;
    return;
  }

  data.forEach(item=>{
    const d = new Date(item.created_at);
    const tarih = d.toISOString().split("T")[0];
    const saat = d.toTimeString().split(" ")[0];

    dataTable.innerHTML += `
    <tr>
      <td>${tarih}</td>
      <td>${saat}</td>
      <td>${item.tur}</td>
      <td>${item.not_text || ""}</td>
      <td><button onclick="duzelt('${item.id}','${item.not_text || ""}')">‚úèÔ∏è</button></td>
    </tr>`;
  });
}

async function duzelt(id, eskiNot){

  const yeni = prompt("Notu d√ºzenle:", eskiNot);
  if(yeni===null) return;

  await supabaseClient
    .from("hareketler")
    .update({ not_text: yeni })
    .eq("id", id);

  loadData();
}

txtSearch.oninput = function(){

  const q = this.value.toLowerCase();

  const filtered = currentData.filter(x =>
    (x.tur || "").toLowerCase().includes(q) ||
    (x.not_text || "").toLowerCase().includes(q)
  );

  renderTable(filtered);
};

function cikis(){
  localStorage.removeItem("aktifKullanici");
  location.reload();
}

</script>
</body>
</html>
