(()=>{'use strict';
const K={persons:'pt_persons_v1',records:'pt_records_v1',adminPinHash:'pt_admin_pin_hash_v1',adminAuthed:'pt_admin_authed_v1'};
const $=id=>document.getElementById(id);
const tabP=$('tabPersonel'),tabA=$('tabAdmin'),viewP=$('viewPersonel'),viewA=$('viewAdmin');
const personSelect=$('personSelect'),btnAddPerson=$('btnAddPerson'),note=$('note'),btnSend=$('btnSend'),btnRefreshP=$('btnRefreshP'),typeButtons=$('typeButtons'),listPersonel=$('listPersonel'),personRangePills=$('personRangePills');
const adminGate=$('adminGate'),adminPanel=$('adminPanel'),adminPin=$('adminPin'),btnAdminLogin=$('btnAdminLogin'),searchAdmin=$('searchAdmin'),personFilterAdmin=$('personFilterAdmin'),adminRangePills=$('adminRangePills'),fromDate=$('fromDate'),toDate=$('toDate'),btnRefreshA=$('btnRefreshA'),btnExportExcel=$('btnExportExcel'),btnBackup=$('btnBackup'),restoreInput=$('restoreInput'),listAdmin=$('listAdmin');
const modalBackdrop=$('modalBackdrop'),modalAddPerson=$('modalAddPerson'),newPersonName=$('newPersonName'),btnSavePerson=$('btnSavePerson');
const modalEdit=$('modalEdit'),editType=$('editType'),editTs=$('editTs'),editNote=$('editNote'),btnSaveEdit=$('btnSaveEdit');
const toast=$('toast');
let selectedType='not',personRangeDays=3,adminRangeDays=7,editingId=null;
const now=()=>Date.now(),pad2=n=>String(n).padStart(2,'0');
const safeParse=(s,f)=>{try{return JSON.parse(s)}catch{return f}};
const esc=s=>String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const showToast=m=>{toast.textContent=m;toast.classList.remove('hidden');clearTimeout(showToast._t);showToast._t=setTimeout(()=>toast.classList.add('hidden'),1400)};
const uid=()=> 'r_'+now().toString(36)+'_'+Math.random().toString(36).slice(2,9);
const fmtTs=ts=>{const d=new Date(ts);return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`};
const startOfDay=ts=>{const d=new Date(ts);d.setHours(0,0,0,0);return d.getTime()};
const withinLastDays=(ts,days)=> ts>= (startOfDay(now())-(days-1)*86400000);
const loadPersons=()=>{const a=safeParse(localStorage.getItem(K.persons),[]);if(Array.isArray(a)&&a.length)return a;const seed=['Ali','Veli'];localStorage.setItem(K.persons,JSON.stringify(seed));return seed};
const savePersons=a=>localStorage.setItem(K.persons,JSON.stringify(a));
const loadRecords=()=>{const a=safeParse(localStorage.getItem(K.records),[]);return Array.isArray(a)?a:[]};
const saveRecords=a=>localStorage.setItem(K.records,JSON.stringify(a));
const setActiveTab=w=>{const isP=w==='p';tabP.classList.toggle('active',isP);tabA.classList.toggle('active',!isP);viewP.classList.toggle('hidden',!isP);viewA.classList.toggle('hidden',isP);if(!isP)ensureAdminGate()};
tabP.addEventListener('click',()=>setActiveTab('p'));tabA.addEventListener('click',()=>setActiveTab('a'));
async function sha256Hex(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}
async function ensureAdminGate(){const authed=localStorage.getItem(K.adminAuthed)==='1';const hasPin=!!localStorage.getItem(K.adminPinHash);if(authed){adminGate.classList.add('hidden');adminPanel.classList.remove('hidden');renderAdmin();return}adminGate.classList.remove('hidden');adminPanel.classList.add('hidden');adminPin.placeholder=hasPin?'PIN gir':'Yeni PIN belirle (4-8 hane)'}
btnAdminLogin.addEventListener('click',async()=>{const pin=(adminPin.value||'').trim();if(pin.length<4){showToast('PIN en az 4 hane');return}const hasPin=!!localStorage.getItem(K.adminPinHash);const h=await sha256Hex(pin);if(!hasPin){localStorage.setItem(K.adminPinHash,h);localStorage.setItem(K.adminAuthed,'1');adminPin.value='';showToast('Admin PIN kaydedildi');ensureAdminGate();return}const saved=localStorage.getItem(K.adminPinHash);if(h===saved){localStorage.setItem(K.adminAuthed,'1');adminPin.value='';showToast('Admin giriş başarılı');ensureAdminGate()}else showToast('PIN yanlış')});
function refreshPersonSelect(){const persons=loadPersons();personSelect.innerHTML='<option value="">Personel Seç</option>'+persons.map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join('')}
function refreshAdminPersonFilter(){const persons=loadPersons();personFilterAdmin.innerHTML='<option value="">Tümü</option>'+persons.map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join('')}
function setType(t){selectedType=t;[...typeButtons.querySelectorAll('button.type')].forEach(b=>b.classList.toggle('active',b.dataset.type===t))}
typeButtons.addEventListener('click',e=>{const b=e.target.closest('button.type');if(!b)return;setType(b.dataset.type||'not');unlockSend()});
function unlockSend(){const p=(personSelect.value||'').trim();const n=(note.value||'').trim();btnSend.disabled=!(p&&n)}
personSelect.addEventListener('change',unlockSend);note.addEventListener('input',unlockSend);
btnSend.addEventListener('click',()=>{const p=(personSelect.value||'').trim();const n=(note.value||'').trim();if(!p){showToast('Önce personel seç');return}if(!n){showToast('Not zorunlu');return}const rec={id:uid(),ts:now(),person:p,type:selectedType||'not',note:n};const records=loadRecords();records.push(rec);saveRecords(records);note.value='';unlockSend();showToast('Kaydedildi');renderPersonel()});
btnRefreshP.addEventListener('click',()=>{renderPersonel();showToast('Yenilendi')});
[...personRangePills.querySelectorAll('.pill')].forEach(p=>p.addEventListener('click',()=>{const days=parseInt(p.dataset.range,10);if(!days)return;personRangeDays=days;[...personRangePills.querySelectorAll('.pill')].forEach(x=>x.classList.toggle('active',x===p));renderPersonel()}));
const openModal=el=>{modalBackdrop.classList.remove('hidden');el.classList.remove('hidden')};
const closeModal=el=>{el.classList.add('hidden');modalBackdrop.classList.add('hidden')};
modalBackdrop.addEventListener('click',()=>{[modalAddPerson,modalEdit].forEach(m=>m.classList.contains('hidden')?null:closeModal(m))});
document.body.addEventListener('click',e=>{const closeId=e.target?.dataset?.close;if(!closeId)return;closeModal($(closeId))});
btnAddPerson.addEventListener('click',()=>{newPersonName.value='';openModal(modalAddPerson);setTimeout(()=>newPersonName.focus(),30)});
btnSavePerson.addEventListener('click',()=>{const name=(newPersonName.value||'').trim();if(name.length<2){showToast('İsim kısa');return}const persons=loadPersons();if(persons.some(x=>x.toLowerCase()===name.toLowerCase())){showToast('Zaten var');return}persons.push(name);savePersons(persons);refreshPersonSelect();refreshAdminPersonFilter();personSelect.value=name;unlockSend();closeModal(modalAddPerson);showToast('Personel eklendi')});
const typeLabel=t=>t==='giris'?'Giriş':t==='cikis'?'Çıkış':t==='izin'?'İzin':'Not';
function itemHtml(r){const t=r.type||'not';const cls=t==='izin'?'warn':'pri';return `<div class="item"><div class="itemTop"><div class="badges"><span class="badge ${cls}">${esc(typeLabel(t))}</span><span class="badge">${esc(r.person)}</span><span class="badge">${esc(fmtTs(r.ts))}</span></div></div><div class="note">${esc(r.note)}</div><div class="itemActions"><button class="btn" data-edit-id="${esc(r.id)}" type="button">Düzelt</button></div></div>`}
const emptyHtml=txt=>`<div class="item"><div class="note">${esc(txt)}</div></div>`;
function bindEditButtons(container){container.querySelectorAll('[data-edit-id]').forEach(btn=>btn.addEventListener('click',()=>{const id=btn.getAttribute('data-edit-id');const rec=loadRecords().find(r=>r.id===id);if(rec)openEdit(rec)}))}
function renderPersonel(){const p=(personSelect.value||'').trim();const records=loadRecords().filter(r=>withinLastDays(r.ts,personRangeDays)).filter(r=>!p||r.person===p).sort((a,b)=>b.ts-a.ts);listPersonel.innerHTML=records.length?records.map(itemHtml).join(''):emptyHtml('Kayıt yok');bindEditButtons(listPersonel)}
function openEdit(rec){editingId=rec.id;editType.value=rec.type||'not';editTs.value=fmtTs(rec.ts);editNote.value=rec.note||'';openModal(modalEdit);setTimeout(()=>editNote.focus(),30)}
btnSaveEdit.addEventListener('click',()=>{if(!editingId)return;const records=loadRecords();const idx=records.findIndex(r=>r.id===editingId);if(idx<0){closeModal(modalEdit);return}const newNote=(editNote.value||'').trim();if(!newNote){showToast('Not zorunlu');return}records[idx].type=editType.value||'not';records[idx].note=newNote;saveRecords(records);closeModal(modalEdit);editingId=null;showToast('Düzeltildi');renderPersonel();renderAdmin()});
const getAdminDateRange=()=>({f:fromDate.value?new Date(fromDate.value+'T00:00:00').getTime():null,t:toDate.value?new Date(toDate.value+'T23:59:59').getTime():null});
function renderAdmin(){if(localStorage.getItem(K.adminAuthed)!=='1')return;const q=(searchAdmin.value||'').trim().toLowerCase();const pf=(personFilterAdmin.value||'').trim();const {f,t}=getAdminDateRange();let records=loadRecords().slice();if(f||t)records=records.filter(r=>(f?r.ts>=f:true)&&(t?r.ts<=t:true));else records=records.filter(r=>withinLastDays(r.ts,adminRangeDays));if(pf)records=records.filter(r=>r.person===pf);if(q)records=records.filter(r=>(r.person+' '+(r.type||'')+' '+(r.note||'')).toLowerCase().includes(q));records.sort((a,b)=>b.ts-a.ts);listAdmin.innerHTML=records.length?records.map(itemHtml).join(''):emptyHtml('Kayıt yok');bindEditButtons(listAdmin)}
[...adminRangePills.querySelectorAll('.pill')].forEach(p=>p.addEventListener('click',()=>{const days=parseInt(p.dataset.range,10);if(!days)return;adminRangeDays=days;fromDate.value='';toDate.value='';[...adminRangePills.querySelectorAll('.pill')].forEach(x=>x.classList.toggle('active',x===p))}));
fromDate.addEventListener('change',()=>{[...adminRangePills.querySelectorAll('.pill')].forEach(x=>x.classList.remove('active'))});
toDate.addEventListener('change',()=>{[...adminRangePills.querySelectorAll('.pill')].forEach(x=>x.classList.remove('active'))});
btnRefreshA.addEventListener('click',()=>{renderAdmin();showToast('Yenilendi')});
btnExportExcel.addEventListener('click',()=>{if(localStorage.getItem(K.adminAuthed)!=='1'){showToast('Admin giriş gerekli');return}const q=(searchAdmin.value||'').trim().toLowerCase();const pf=(personFilterAdmin.value||'').trim();const {f,t}=getAdminDateRange();let records=loadRecords().slice();if(f||t)records=records.filter(r=>(f?r.ts>=f:true)&&(t?r.ts<=t:true));else records=records.filter(r=>withinLastDays(r.ts,adminRangeDays));if(pf)records=records.filter(r=>r.person===pf);if(q)records=records.filter(r=>(r.person+' '+(r.type||'')+' '+(r.note||'')).toLowerCase().includes(q));records.sort((a,b)=>b.ts-a.ts);const rows=records.map(r=>`<tr><td>${esc(fmtTs(r.ts))}</td><td>${esc(r.person)}</td><td>${esc(typeLabel(r.type||'not'))}</td><td>${esc(r.note||'')}</td></tr>`).join('');const html=`<!doctype html><html><head><meta charset="utf-8"></head><body><table border="1"><thead><tr><th>Tarih</th><th>Personel</th><th>Tür</th><th>Not</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;const blob=new Blob(['\ufeff',html],{type:'application/vnd.ms-excel;charset=utf-8'});const a=document.createElement('a');const dt=new Date();a.download=`personel_takip_${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}.xls`;a.href=URL.createObjectURL(blob);document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),500)});
btnBackup.addEventListener('click',()=>{if(localStorage.getItem(K.adminAuthed)!=='1'){showToast('Admin giriş gerekli');return}const payload={v:1,exportedAt:now(),persons:loadPersons(),records:loadRecords()};const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json;charset=utf-8'});const a=document.createElement('a');const dt=new Date();a.download=`personel_takip_yedek_${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}.json`;a.href=URL.createObjectURL(blob);document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),500)});
restoreInput.addEventListener('change',async()=>{if(localStorage.getItem(K.adminAuthed)!=='1'){showToast('Admin giriş gerekli');restoreInput.value='';return}const file=restoreInput.files&&restoreInput.files[0];restoreInput.value='';if(!file)return;try{const data=JSON.parse(await file.text());const persons=loadPersons();const records=loadRecords();const newPersons=Array.isArray(data.persons)?data.persons:[];const newRecords=Array.isArray(data.records)?data.records:[];const set=new Set(persons.map(x=>x.toLowerCase()));newPersons.forEach(p=>{const s=String(p||'').trim();if(!s)return;const k=s.toLowerCase();if(!set.has(k)){persons.push(s);set.add(k)}});const idset=new Set(records.map(r=>r.id));newRecords.forEach(r=>{if(!r||!r.id||idset.has(r.id))return;records.push({id:String(r.id),ts:Number(r.ts)||now(),person:String(r.person||'').trim()||'Bilinmiyor',type:String(r.type||'not'),note:String(r.note||'').trim()||'(boş)'});idset.add(String(r.id))});savePersons(persons);saveRecords(records);refreshPersonSelect();refreshAdminPersonFilter();renderPersonel();renderAdmin();showToast('Yedekten alındı')}catch(e){showToast('Yedek okunamadı')}});
function init(){refreshPersonSelect();refreshAdminPersonFilter();setType('not');unlockSend();renderPersonel()}
init();
})();