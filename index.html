<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personel Takip (FINAL Temizleme)</title>

  <!-- ‚úÖ Tek dosya / Not defteri gibi -->
  <!-- ‚úÖ 5000 limit (listeleme + export i√ßin) -->
  <!-- ‚úÖ Arama: personel + not -->
  <!-- ‚úÖ Tarih filtresi net (ba≈ülangƒ±√ß-biti≈ü) -->
  <!-- ‚úÖ Gereksiz kod temiz -->
  <!-- ‚úÖ Admin sade: PIN ile giri≈ü (ekranda PIN yazmaz) -->

  <style>
    :root{
      --bg:#0b1220; --card:#0f1b33; --card2:#0d1730; --txt:#eaf0ff; --muted:#9fb2d6;
      --line:rgba(255,255,255,.10); --btn:#1f5eff; --btn2:#1c2740; --danger:#ff3b3b;
      --ok:#19c37d; --warn:#ffcc00;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(to bottom, rgba(11,18,32,.98), rgba(11,18,32,.70));
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .spacer{flex:1}
    h1{margin:0; font-size:16px; letter-spacing:.2px}
    .pill{
      padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted);
      font-size:12px; background:rgba(255,255,255,.03)
    }
    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 10px; font-size:14px}
    .muted{color:var(--muted); font-size:12px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--txt);
      outline:none;
    }
    textarea{min-height:88px; resize:vertical}
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px; border-radius:12px; color:white; background:var(--btn);
      font-weight:600; font-size:13px;
    }
    .btn.secondary{background:var(--btn2); border:1px solid var(--line); color:var(--txt)}
    .btn.danger{background:var(--danger)}
    .btn.ok{background:var(--ok)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .mini{font-size:12px; padding:8px 10px; border-radius:10px}
    .hr{height:1px; background:var(--line); margin:10px 0}
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
      vertical-align:top;
    }
    .table th{color:#cfe0ff; text-align:left; font-weight:700; background:rgba(255,255,255,.04)}
    .table tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:999px; border:1px solid var(--line);
      font-size:12px; color:var(--muted);
      background:rgba(255,255,255,.03)
    }
    .dot{width:8px; height:8px; border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--danger)}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(20,30,55,.95);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      display:none;
      max-width:min(92vw, 780px);
      z-index:99;
    }
    .toast.show{display:block}
    .toast b{font-size:13px}
    .toast .muted{margin-top:4px}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:#d7e6ff;
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .two{grid-template-columns:1fr} }
    .hide{display:none !important}
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- XLSX (opsiyonel export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>Personel Takip</h1>
      <span class="pill" id="statusPill">Durum: ‚Äî</span>
      <span class="pill">Limit: <b>5000</b></span>
      <div class="spacer"></div>

      <button class="btn secondary mini" id="btnSync">Sunucudan Senkronize Et</button>
      <button class="btn secondary mini" id="btnAdmin">Admin</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">Arama: <span class="kbd">personel</span> + <span class="kbd">not</span> | Tarih: <span class="kbd">ba≈ülangƒ±√ß</span>‚Äì<span class="kbd">biti≈ü</span> (g√ºn sonu dahil)</span>
      <div class="spacer"></div>
      <span class="muted">Cihaz deƒüi≈ütiyse: Admin ‚Üí ‚ÄúGeri Y√ºkle‚Äù kullanƒ±n.</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- SOL: Kayƒ±t Giri≈üi -->
    <section class="card">
      <h2>Yeni Hareket</h2>

      <div class="two">
        <div>
          <label>Personel</label>
          <select id="selPersonel"></select>
          <div class="muted" style="margin-top:6px">Personel yoksa Admin‚Äôden ekleyin.</div>
        </div>
        <div>
          <label>Tarih / Saat</label>
          <input id="inpDT" type="datetime-local" />
          <div class="muted" style="margin-top:6px">Bo≈ü bƒ±rakƒ±rsan ‚Äú≈üimdi‚Äù kaydeder.</div>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>T√ºr</label>
          <select id="selTip">
            <option value="GIRIS">Giri≈ü</option>
            <option value="CIKIS">√áƒ±kƒ±≈ü</option>
            <option value="NOT">Not</option>
          </select>
        </div>
        <div>
          <label>Kƒ±sa Etiket (opsiyonel)</label>
          <input id="inpEtiket" placeholder="√∂rn: Servis / Ge√ß / ƒ∞zin" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Not (opsiyonel)</label>
        <textarea id="inpNot" placeholder="Bu not aramada √ßƒ±kar (personel + not)."></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnKaydet">Kaydet</button>
        <button class="btn secondary" id="btnTemizle">Temizle</button>
        <div class="spacer"></div>
        <span class="tag" id="liveTag"><span class="dot warn"></span>Bekliyor</span>
      </div>

      <div class="hr"></div>

      <h2>Liste / Filtre</h2>

      <div class="two">
        <div>
          <label>Arama (personel adƒ± + not i√ßinde)</label>
          <input id="inpAra" placeholder="√∂rn: s√ºleyman / ge√ß kaldƒ± / izin" />
        </div>
        <div>
          <label>Personel se√ß (opsiyonel)</label>
          <select id="selFilterPersonel"></select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Ba≈ülangƒ±√ß (g√ºn ba≈üƒ±)</label>
          <input id="inpStart" type="date" />
        </div>
        <div>
          <label>Biti≈ü (g√ºn sonu dahil)</label>
          <input id="inpEnd" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnUygula">Uygula</button>
        <button class="btn secondary" id="btnSifirla">Sƒ±fƒ±rla</button>
        <div class="spacer"></div>
        <button class="btn secondary" id="btnExport">Excel (XLSX) Dƒ±≈üa Ver</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Not: Listeleme ve export maksimum <b>5000</b> kayƒ±t √ßeker (trafik d√º≈ü√ºk).
      </div>
    </section>

    <!-- SAƒû: Liste -->
    <section class="card">
      <div class="row">
        <h2 style="margin:0">Hareketler</h2>
        <div class="spacer"></div>
        <span class="pill" id="countPill">0 kayƒ±t</span>
      </div>

      <div style="margin-top:10px; overflow:auto; max-height:65vh">
        <table class="table">
          <thead>
            <tr>
              <th style="min-width:140px">Tarih</th>
              <th style="min-width:130px">Personel</th>
              <th style="min-width:90px">T√ºr</th>
              <th>Not</th>
              <th class="right" style="min-width:110px">ƒ∞≈ülem</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn secondary mini" id="btnPrev">‚Üê √ñnceki</button>
        <button class="btn secondary mini" id="btnNext">Sonraki ‚Üí</button>
        <div class="spacer"></div>
        <span class="muted">Sayfa: <b id="pageInfo">1</b></span>
      </div>
    </section>

  </div>
</main>

<!-- ADMIN MODAL -->
<div id="adminModal" class="toast" style="top:70px; bottom:auto; transform:translateX(-50%);">
  <div class="row">
    <b>Admin</b>
    <div class="spacer"></div>
    <button class="btn secondary mini" id="btnAdminClose">Kapat</button>
  </div>
  <div class="muted" style="margin-top:6px">PIN ile giri≈ü. (PIN ekranda yazmaz.)</div>

  <div class="hr"></div>

  <div id="adminLocked">
    <label>Admin PIN</label>
    <input id="adminPin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnAdminLogin">Giri≈ü</button>
      <span class="muted">Yanlƒ±≈ü deneme: <b id="pinTry">0</b></span>
      <div class="spacer"></div>
      <span class="muted">ƒ∞pucu: PIN‚Äôi kod i√ßine yazma; localStorage‚Äôdan ayarla.</span>
    </div>
    <div class="muted" style="margin-top:8px">
      ƒ∞lk kurulum: Tarayƒ±cƒ± konsolunda <span class="kbd">localStorage.setItem('ADMIN_PIN','070707')</span> gibi ayarla.
    </div>
  </div>

  <div id="adminUnlocked" class="hide">
    <div class="row">
      <span class="tag"><span class="dot ok"></span>Admin aktif</span>
      <div class="spacer"></div>
      <button class="btn secondary mini" id="btnAdminLogout">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px; font-size:13px">Personel Y√∂netimi</h3>
    <div class="two">
      <div>
        <label>Yeni personel adƒ±</label>
        <input id="inpNewPersonel" placeholder="√∂rn: S√ºleyman" />
      </div>
      <div style="display:flex; gap:10px; align-items:flex-end">
        <button class="btn ok" id="btnAddPersonel" style="width:100%">Ekle</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn danger mini" id="btnDelPersonel">Se√ßili personeli sil</button>
      <span class="muted">Dikkat: Silme, hareketleri etkilemez (FK varsa engellenir).</span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px; font-size:13px">Yedek / Geri Y√ºkle</h3>
    <div class="row">
      <button class="btn secondary mini" id="btnBackup">JSON ƒ∞ndir</button>
      <label class="btn secondary mini" style="cursor:pointer; display:inline-flex; align-items:center; gap:8px">
        JSON Y√ºkle
        <input id="fileRestore" type="file" accept="application/json" style="display:none" />
      </label>
      <div class="spacer"></div>
      <span class="muted" id="restoreReport">‚Äî</span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px; font-size:13px">Temizlik</h3>
    <div class="row">
      <button class="btn danger mini" id="btnDeleteRow">Se√ßili satƒ±rƒ± sil</button>
      <span class="muted">Listeden satƒ±rƒ±n ‚ÄúSil‚Äù butonuyla da yaparsƒ±n.</span>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <b id="toastTitle">‚Äî</b>
  <div class="muted" id="toastMsg">‚Äî</div>
</div>

<script>
/* =========================
   üîß AYARLAR (tek yer)
========================= */
const LIMIT = 5000;              // ‚úÖ 5000 limit i≈üi
const PAGE_SIZE = 100;           // liste sayfa boyu
const STORAGE = {
  ADMIN_PIN: 'ADMIN_PIN',
  ADMIN_OK: 'ADMIN_OK',
  LAST_FILTERS: 'LAST_FILTERS',
  CACHE_PERSONEL: 'CACHE_PERSONEL',
  CACHE_UPDATED: 'CACHE_UPDATED',
  CACHE_ROWS: 'CACHE_ROWS'
};

// ‚úÖ Supabase Config (BURAYI DOLDUR)
const SUPABASE_URL = "https://ngnpocqaznpuggsvwbif.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec";

// ‚úÖ Tablo adlarƒ± (Supabase)
const TBL_PERSONEL = "personeller";
const TBL_HAREKET = "hareketler";

/* =========================
   üß† STATE
========================= */
let supa = null;
let personelList = [];
let rows = [];                // mevcut filtreli data
let page = 1;
let selectedRowId = null;

let pinTry = 0;

/* =========================
   üß© UI Helpers
========================= */
const $ = (id) => document.getElementById(id);
function toast(title, msg){
  $('toastTitle').textContent = title || 'Bilgi';
  $('toastMsg').textContent = msg || '';
  $('toast').classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> $('toast').classList.remove('show'), 2200);
}
function setStatus(text, ok=true){
  $('statusPill').textContent = `Durum: ${text}`;
  $('liveTag').innerHTML = ok
    ? `<span class="dot ok"></span>Baƒülƒ±`
    : `<span class="dot warn"></span>${text}`;
}
function fmtDT(iso){
  try{
    const d = new Date(iso);
    const pad = (n)=> String(n).padStart(2,'0');
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{ return iso || ''; }
}
function escapeHtml(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
function startOfDayISO(dateStr){
  // dateStr: YYYY-MM-DD
  if(!dateStr) return null;
  return new Date(dateStr + "T00:00:00").toISOString();
}
function endOfDayISO(dateStr){
  // G√ºn sonu dahil etmek i√ßin 23:59:59.999
  if(!dateStr) return null;
  const d = new Date(dateStr + "T23:59:59.999");
  return d.toISOString();
}

/* =========================
   üîå INIT
========================= */
init();

async function init(){
  // Supabase ba≈ülat
  try{
    if(SUPABASE_URL.includes("YOUR_") || SUPABASE_ANON.includes("YOUR_")){
      setStatus("Supabase ayarƒ± yok", false);
      toast("Ayar", "SUPABASE_URL ve SUPABASE_ANON doldur.");
      // Yine de UI √ßalƒ±≈üsƒ±n
    }else{
      supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      setStatus("Baƒülantƒ± hazƒ±r", true);
    }
  }catch(e){
    setStatus("Baƒülantƒ± hatasƒ±", false);
    toast("Hata", e.message);
  }

  wireEvents();
  loadFiltersFromStorage();

  await loadPersonel();   // personel dropdown
  await applyFilters();   // ilk liste
}

function wireEvents(){
  $('btnKaydet').addEventListener('click', saveHareket);
  $('btnTemizle').addEventListener('click', clearForm);

  $('btnUygula').addEventListener('click', async ()=>{ page=1; await applyFilters(); });
  $('btnSifirla').addEventListener('click', async ()=>{ resetFilters(); page=1; await applyFilters(); });

  $('btnPrev').addEventListener('click', async ()=>{ if(page>1){ page--; renderTable(); } });
  $('btnNext').addEventListener('click', async ()=>{
    const maxPage = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
    if(page < maxPage){ page++; renderTable(); }
  });

  $('btnSync').addEventListener('click', async ()=>{
    toast("Senkron", "Sunucudan √ßekiliyor‚Ä¶");
    await loadPersonel(true);
    await applyFilters(true);
  });

  $('btnExport').addEventListener('click', exportXLSX);

  // Admin
  $('btnAdmin').addEventListener('click', ()=> openAdmin(true));
  $('btnAdminClose').addEventListener('click', ()=> openAdmin(false));
  $('btnAdminLogin').addEventListener('click', adminLogin);
  $('btnAdminLogout').addEventListener('click', adminLogout);

  $('btnAddPersonel').addEventListener('click', addPersonel);
  $('btnDelPersonel').addEventListener('click', delPersonel);

  $('btnBackup').addEventListener('click', backupJSON);
  $('fileRestore').addEventListener('change', restoreJSON);

  $('btnDeleteRow').addEventListener('click', ()=> {
    if(!selectedRowId) return toast("Sil", "√ñnce listeden bir satƒ±r se√ß.");
    deleteRow(selectedRowId);
  });

  // Satƒ±r se√ßimi i√ßin: tabloda tƒ±klanƒ±nca se√ß
  $('tbody').addEventListener('click', (e)=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    const id = tr.getAttribute('data-id');
    selectedRowId = id || null;
  });

  // Enter ile arama uygulansƒ±n
  $('inpAra').addEventListener('keydown', async (e)=>{
    if(e.key === 'Enter'){ page=1; await applyFilters(); }
  });
}

/* =========================
   üßæ FILTERS
========================= */
function loadFiltersFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE.LAST_FILTERS);
    if(!raw) return;
    const f = JSON.parse(raw);
    $('inpAra').value = f.q || '';
    $('inpStart').value = f.start || '';
    $('inpEnd').value = f.end || '';
  }catch{}
}
function saveFiltersToStorage(){
  const f = {
    q: $('inpAra').value.trim(),
    p: $('selFilterPersonel').value || '',
    start: $('inpStart').value || '',
    end: $('inpEnd').value || ''
  };
  localStorage.setItem(STORAGE.LAST_FILTERS, JSON.stringify(f));
}
function resetFilters(){
  $('inpAra').value = '';
  $('inpStart').value = '';
  $('inpEnd').value = '';
  $('selFilterPersonel').value = '';
  saveFiltersToStorage();
}

/* =========================
   üë• PERSONEL
========================= */
async function loadPersonel(force=false){
  // cache
  const cacheOk = !force && localStorage.getItem(STORAGE.CACHE_PERSONEL);
  if(cacheOk){
    try{
      personelList = JSON.parse(localStorage.getItem(STORAGE.CACHE_PERSONEL)) || [];
      fillPersonelSelects();
      return;
    }catch{}
  }

  if(!supa){
    personelList = [];
    fillPersonelSelects();
    return;
  }

  const { data, error } = await supa
    .from(TBL_PERSONEL)
    .select('*')
    .order('ad', {ascending:true});

  if(error){
    toast("Personel", error.message);
    personelList = [];
  }else{
    personelList = data || [];
    localStorage.setItem(STORAGE.CACHE_PERSONEL, JSON.stringify(personelList));
    localStorage.setItem(STORAGE.CACHE_UPDATED, new Date().toISOString());
  }

  fillPersonelSelects();
}

function fillPersonelSelects(){
  const makeOpts = (withAll=false)=>{
    const arr = [];
    if(withAll) arr.push(`<option value="">(Hepsi)</option>`);
    if(!personelList.length) arr.push(`<option value="" disabled selected>Personel yok</option>`);
    for(const p of personelList){
      arr.push(`<option value="${p.id}">${escapeHtml(p.ad || '')}</option>`);
    }
    return arr.join('');
  };

  $('selPersonel').innerHTML = makeOpts(false);
  $('selFilterPersonel').innerHTML = makeOpts(true);

  // Filtrede kayƒ±tlƒ± se√ßim varsa koru
  try{
    const f = JSON.parse(localStorage.getItem(STORAGE.LAST_FILTERS) || '{}');
    if(f.p) $('selFilterPersonel').value = f.p;
  }catch{}
}

/* =========================
   ‚úçÔ∏è HAREKET KAYIT
========================= */
function clearForm(){
  $('inpDT').value = '';
  $('selTip').value = 'GIRIS';
  $('inpEtiket').value = '';
  $('inpNot').value = '';
}

async function saveHareket(){
  const personel_id = $('selPersonel').value;
  if(!personel_id){
    return toast("Eksik", "Personel se√ß.");
  }

  const tip = $('selTip').value;
  const etiket = $('inpEtiket').value.trim();
  const not = $('inpNot').value.trim();

  let dt = $('inpDT').value;
  let tarihIso = null;
  if(dt){
    // datetime-local -> ISO
    const d = new Date(dt);
    tarihIso = d.toISOString();
  }else{
    tarihIso = new Date().toISOString();
  }

  if(!supa){
    toast("Supabase", "Baƒülantƒ± yok. Ayarlarƒ± doldur.");
    return;
  }

  const payload = {
    personel_id,
    tip,
    etiket: etiket || null,
    not: not || null,
    tarih: tarihIso
  };

  $('btnKaydet').disabled = true;
  try{
    const { error } = await supa.from(TBL_HAREKET).insert(payload);
    if(error) throw error;
    toast("Kayƒ±t", "Kaydedildi ‚úÖ");
    clearForm();
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }finally{
    $('btnKaydet').disabled = false;
  }
}

/* =========================
   üîé LISTE / APPLY FILTERS
========================= */
async function applyFilters(force=false){
  saveFiltersToStorage();

  const q = $('inpAra').value.trim().toLowerCase();
  const personelFilter = $('selFilterPersonel').value || '';
  const start = $('inpStart').value;
  const end = $('inpEnd').value;

  if(!supa){
    rows = [];
    renderTable();
    setStatus("Supabase ayarƒ± yok", false);
    return;
  }

  // üî• Sunucudan sadece gerekli kolonlar
  // Personel adƒ±nƒ± join gibi almak i√ßin iki adƒ±m: hareketleri √ßek + personel map
  // (Supabase foreign table select de olur ama en sade ve saƒülam y√∂ntem: map)
  // NOT: 5000 limit burada uygulanƒ±r.

  let query = supa
    .from(TBL_HAREKET)
    .select('id, personel_id, tip, etiket, not, tarih')
    .order('tarih', {ascending:false})
    .limit(LIMIT);

  // Tarih filtresi net:
  // start varsa >= startOfDay
  // end varsa <= endOfDay (g√ºn sonu dahil)
  const startIso = startOfDayISO(start);
  const endIso = endOfDayISO(end);

  if(startIso) query = query.gte('tarih', startIso);
  if(endIso) query = query.lte('tarih', endIso);
  if(personelFilter) query = query.eq('personel_id', personelFilter);

  $('btnUygula').disabled = true;
  $('btnSifirla').disabled = true;

  try{
    // personelleri taze olsun
    if(force) await loadPersonel(true);
    const pmap = new Map(personelList.map(p => [p.id, p.ad || '']));

    const { data, error } = await query;
    if(error) throw error;

    const raw = data || [];

    // Arama: personel + not + etiket
    if(q){
      rows = raw.filter(r=>{
        const ad = (pmap.get(r.personel_id) || '').toLowerCase();
        const not = (r.not || '').toLowerCase();
        const et = (r.etiket || '').toLowerCase();
        const tip = (r.tip || '').toLowerCase();
        return ad.includes(q) || not.includes(q) || et.includes(q) || tip.includes(q);
      });
    }else{
      rows = raw;
    }

    // Cache rows opsiyonel (trafik d√º≈ü√ºk, ama isterse hƒ±zlƒ± a√ßƒ±lƒ±≈ü)
    localStorage.setItem(STORAGE.CACHE_ROWS, JSON.stringify(rows.slice(0, Math.min(rows.length, LIMIT))));
    renderTable(pmap);

    setStatus("Hazƒ±r", true);
  }catch(e){
    toast("Hata", e.message);
    setStatus("Listeleme hatasƒ±", false);
  }finally{
    $('btnUygula').disabled = false;
    $('btnSifirla').disabled = false;
  }
}

function renderTable(pmapOverride){
  const pmap = pmapOverride || new Map(personelList.map(p => [p.id, p.ad || '']));
  const total = rows.length;
  $('countPill').textContent = `${total} kayƒ±t`;

  const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(page > maxPage) page = maxPage;
  $('pageInfo').textContent = `${page} / ${maxPage}`;

  const startIdx = (page-1) * PAGE_SIZE;
  const slice = rows.slice(startIdx, startIdx + PAGE_SIZE);

  const html = slice.map(r=>{
    const ad = pmap.get(r.personel_id) || '‚Äî';
    const tip = r.tip || '‚Äî';
    const not = [r.etiket ? `#${r.etiket}` : '', r.not || ''].filter(Boolean).join(' ');
    const id = r.id;

    return `
      <tr data-id="${escapeHtml(id)}">
        <td>${escapeHtml(fmtDT(r.tarih))}</td>
        <td>${escapeHtml(ad)}</td>
        <td>${escapeHtml(tip)}</td>
        <td>${escapeHtml(not)}</td>
        <td class="right">
          <button class="btn secondary mini" onclick="window.__pickRow('${escapeHtml(id)}')">Se√ß</button>
          <button class="btn danger mini" onclick="window.__deleteRow('${escapeHtml(id)}')">Sil</button>
        </td>
      </tr>
    `;
  }).join('');

  $('tbody').innerHTML = html || `<tr><td colspan="5" class="muted">Kayƒ±t yok.</td></tr>`;
}

// global hooks
window.__pickRow = (id)=>{
  selectedRowId = id;
  toast("Se√ßildi", "Satƒ±r se√ßildi. Admin ‚Üí Se√ßili satƒ±rƒ± sil de kullanabilirsin.");
};
window.__deleteRow = async (id)=>{
  // listeden sil: admin kontrol√º istersen buradan ≈üart ko≈ü
  const ok = isAdmin();
  if(!ok) return toast("Yetki", "Silmek i√ßin Admin giri≈üi gerekli.");
  await deleteRow(id);
};

/* =========================
   üóëÔ∏è DELETE
========================= */
async function deleteRow(id){
  if(!supa) return toast("Supabase", "Baƒülantƒ± yok.");
  if(!id) return;

  const yes = confirm("Bu satƒ±r silinsin mi?");
  if(!yes) return;

  try{
    const { error } = await supa.from(TBL_HAREKET).delete().eq('id', id);
    if(error) throw error;
    toast("Sil", "Silindi ‚úÖ");
    selectedRowId = null;
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

/* =========================
   üîê ADMIN (PIN)
========================= */
function openAdmin(show){
  const m = $('adminModal');
  if(show){
    m.classList.add('show');
    // admin durumuna g√∂re ekran
    const ok = isAdmin();
    $('adminLocked').classList.toggle('hide', ok);
    $('adminUnlocked').classList.toggle('hide', !ok);
    $('pinTry').textContent = String(pinTry);
  }else{
    m.classList.remove('show');
  }
}

function isAdmin(){
  return localStorage.getItem(STORAGE.ADMIN_OK) === '1';
}

function adminLogin(){
  const pin = $('adminPin').value || '';
  const real = localStorage.getItem(STORAGE.ADMIN_PIN) || '';

  if(!real){
    pinTry++;
    $('pinTry').textContent = String(pinTry);
    toast("Admin", "ADMIN_PIN ayarlƒ± deƒüil (localStorage).");
    return;
  }

  if(pin === real){
    localStorage.setItem(STORAGE.ADMIN_OK, '1');
    $('adminPin').value = '';
    toast("Admin", "Giri≈ü ba≈üarƒ±lƒ± ‚úÖ");
    openAdmin(true);
  }else{
    pinTry++;
    $('pinTry').textContent = String(pinTry);
    toast("Admin", "PIN yanlƒ±≈ü.");
  }
}

function adminLogout(){
  localStorage.removeItem(STORAGE.ADMIN_OK);
  toast("Admin", "√áƒ±kƒ±≈ü yapƒ±ldƒ±.");
  openAdmin(true);
}

/* =========================
   ‚ûï PERSONEL CRUD (ADMIN)
========================= */
async function addPersonel(){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  const ad = $('inpNewPersonel').value.trim();
  if(!ad) return toast("Eksik", "Personel adƒ± yaz.");

  if(!supa) return toast("Supabase", "Baƒülantƒ± yok.");

  try{
    const { error } = await supa.from(TBL_PERSONEL).insert({ ad });
    if(error) throw error;
    $('inpNewPersonel').value = '';
    toast("Personel", "Eklendi ‚úÖ");
    await loadPersonel(true);
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

async function delPersonel(){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  const id = $('selPersonel').value;
  if(!id) return toast("Eksik", "Silmek i√ßin personel se√ß.");

  const yes = confirm("Se√ßili personel silinsin mi?");
  if(!yes) return;

  if(!supa) return toast("Supabase", "Baƒülantƒ± yok.");

  try{
    const { error } = await supa.from(TBL_PERSONEL).delete().eq('id', id);
    if(error) throw error;
    toast("Personel", "Silindi ‚úÖ");
    await loadPersonel(true);
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

/* =========================
   üíæ BACKUP / RESTORE (ADMIN)
========================= */
async function backupJSON(){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  if(!supa) return toast("Supabase", "Baƒülantƒ± yok.");

  try{
    toast("Yedek", "√áekiliyor‚Ä¶");
    const { data: p, error: ep } = await supa.from(TBL_PERSONEL).select('*').order('ad', {ascending:true}).limit(LIMIT);
    if(ep) throw ep;

    const { data: h, error: eh } = await supa.from(TBL_HAREKET).select('*').order('tarih', {ascending:false}).limit(LIMIT);
    if(eh) throw eh;

    const payload = {
      meta: { createdAt: new Date().toISOString(), limit: LIMIT },
      personeller: p || [],
      hareketler: h || []
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `personel_takip_yedek_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    toast("Yedek", "JSON indirildi ‚úÖ");
  }catch(e){
    toast("Hata", e.message);
  }
}

async function restoreJSON(evt){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  const file = evt.target.files?.[0];
  evt.target.value = '';
  if(!file) return;

  if(!supa) return toast("Supabase", "Baƒülantƒ± yok.");

  try{
    const text = await file.text();
    const json = JSON.parse(text);

    const p = Array.isArray(json.personeller) ? json.personeller : [];
    const h = Array.isArray(json.hareketler) ? json.hareketler : [];

    // √áakƒ±≈üanlarƒ± atla: id √ºzerinden upsert yerine "insert ignore" yok.
    // En g√ºvenlisi: tek tek dene, hata olursa say.
    let okP=0, skipP=0, okH=0, skipH=0;

    toast("Geri Y√ºkle", "Y√ºkleniyor‚Ä¶");

    // Personel
    for(const item of p){
      if(!item || !item.ad) { skipP++; continue; }
      // id zorlamƒ±yoruz; yeni id alsƒ±n diye ad ile ekliyoruz, ama aynƒ± ad varsa tekrar ekleyebilir.
      // ƒ∞stersen benzersiz ad kuralƒ± koyarsƒ±n.
      const { error } = await supa.from(TBL_PERSONEL).insert({ ad: item.ad });
      if(error) skipP++; else okP++;
      if(okP + skipP >= LIMIT) break;
    }

    await loadPersonel(true);
    const pmap = new Map(personelList.map(x=>[x.ad?.toLowerCase(), x.id]));

    // Hareket
    for(const item of h){
      if(!item) { skipH++; continue; }
      const ad = (item.personel_ad || item.personelName || '').toString().trim().toLowerCase();
      let personel_id = item.personel_id;

      // Eƒüer backup personel_id ile geldi ama yeni tabloda uyu≈ümayabilir.
      // Ad ile e≈üle≈ütirme denemesi:
      if(ad && pmap.has(ad)) personel_id = pmap.get(ad);

      // personel_id yoksa atla
      if(!personel_id){ skipH++; continue; }

      const payload = {
        personel_id,
        tip: item.tip || 'NOT',
        etiket: item.etiket || null,
        not: item.not || null,
        tarih: item.tarih || new Date().toISOString()
      };

      const { error } = await supa.from(TBL_HAREKET).insert(payload);
      if(error) skipH++; else okH++;
      if(okH + skipH >= LIMIT) break;
    }

    $('restoreReport').textContent = `Personel: +${okP} (atla:${skipP}) | Hareket: +${okH} (atla:${skipH})`;
    toast("Geri Y√ºkle", "Bitti ‚úÖ");
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

/* =========================
   üì§ EXPORT XLSX (5000 limit)
========================= */
function exportXLSX(){
  try{
    if(!rows.length) return toast("Excel", "Kayƒ±t yok.");
    const pmap = new Map(personelList.map(p => [p.id, p.ad || '']));

    const data = rows.slice(0, LIMIT).map(r=>({
      "Tarih": fmtDT(r.tarih),
      "Personel": pmap.get(r.personel_id) || '',
      "T√ºr": r.tip || '',
      "Etiket": r.etiket || '',
      "Not": r.not || ''
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Hareketler");
    XLSX.writeFile(wb, `personel_hareketleri_${new Date().toISOString().slice(0,10)}.xlsx`);
    toast("Excel", "XLSX indirildi ‚úÖ");
  }catch(e){
    toast("Hata", e.message);
  }
}
</script>
</body>
</html>
