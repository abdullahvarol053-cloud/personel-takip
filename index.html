<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personel Takip - Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; padding:20px; }
.card { background:#fff; padding:16px; border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,0.05); margin-bottom:14px; }
input, button { border-radius:12px; padding:10px; border:1px solid #d1d5db; }
button.primary { background:#2563eb; color:#fff; border:none; cursor:pointer; }
button.danger { background:#dc2626; color:#fff; border:none; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border-bottom:1px solid #e5e7eb; padding:8px; font-size:14px; }
th { background:#f9fafb; text-align:left; }
</style>
</head>
<body>

<h2>ðŸ“Š Personel Takip - Admin</h2>

<div class="card">
BaÅŸlangÄ±Ã§ <input type="date" id="dtStart">
BitiÅŸ <input type="date" id="dtEnd">
<button class="primary" id="btnFilter">Filtrele</button>
<button id="btnClear">Temizle</button>
<button class="primary" id="btnBackup">ðŸ’¾ Yedek</button>
<button class="danger" id="btnRestore">ðŸ“‚ Geri YÃ¼kle</button>
<input type="file" id="fileRestore" accept=".json" hidden>

<div style="margin-top:10px;">
<input type="text" id="txtSearch" placeholder="ðŸ”Ž Personel / TÃ¼r / Not ara..." style="width:100%;">
</div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Tarih</th>
<th>Saat</th>
<th>Personel</th>
<th>TÃ¼r</th>
<th>Not</th>
</tr>
</thead>
<tbody id="dataTable">
<tr><td colspan="5" style="text-align:center;">YÃ¼kleniyor...</td></tr>
</tbody>
</table>
</div>

<script>

const SUPABASE_URL = "https://ngnpocqaznpuggsvwbif.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentData = [];

function getToday(){
  return new Date().toISOString().split("T")[0];
}

window.onload = async ()=>{
  const today = getToday();
  dtStart.value = today;
  dtEnd.value = today;
  await loadData(today,today);
};

async function loadData(start,end){

  const { data, error } = await supabaseClient
    .from("hareketler")
    .select("*")
    .gte("created_at", start+"T00:00:00")
    .lte("created_at", end+"T23:59:59")
    .order("created_at",{ascending:false});

  if(error){
    dataTable.innerHTML =
    `<tr><td colspan="5" style="color:red;text-align:center;">${error.message}</td></tr>`;
    return;
  }

  currentData = data || [];
  renderTable(currentData);
}

function renderTable(data){

  dataTable.innerHTML="";

  if(!data.length){
    dataTable.innerHTML =
    `<tr><td colspan="5" style="text-align:center;">Veri yok</td></tr>`;
    return;
  }

  data.forEach(item=>{
    const d = new Date(item.created_at);
    const tarih = d.toISOString().split("T")[0];
    const saat = d.toTimeString().split(" ")[0];

    dataTable.innerHTML += `
    <tr>
      <td>${tarih}</td>
      <td>${saat}</td>
      <td>${item.personel_id}</td>
      <td>${item.tur}</td>
      <td>${item.not_text || ""}</td>
    </tr>`;
  });
}

btnFilter.onclick = async ()=>{
  if(!dtStart.value || !dtEnd.value) return alert("Tarih seÃ§");
  await loadData(dtStart.value, dtEnd.value);
};

btnClear.onclick = async ()=>{
  const today = getToday();
  dtStart.value=today;
  dtEnd.value=today;
  await loadData(today,today);
};

btnBackup.onclick = async ()=>{
  const { data } = await supabaseClient
    .from("hareketler")
    .select("*");

  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href=url;
  a.download="personel_yedek.json";
  a.click();
  URL.revokeObjectURL(url);
};

btnRestore.onclick = ()=> fileRestore.click();

fileRestore.onchange = async (e)=>{
  if(!confirm("TÃ¼m veriler silinecek. Emin misin?")) return;

  const file = e.target.files[0];
  if(!file) return;

  const text = await file.text();
  const json = JSON.parse(text);

  await supabaseClient.from("hareketler").delete().neq("id",0);
  await supabaseClient.from("hareketler").insert(json);

  const today=getToday();
  await loadData(today,today);
};

txtSearch.oninput = function(){

  const val = this.value.toLowerCase();

  const filtered = currentData.filter(item=>{
    return (item.personel_id || "").toLowerCase().includes(val) ||
           (item.tur || "").toLowerCase().includes(val) ||
           (item.not_text || "").toLowerCase().includes(val);
  });

  renderTable(filtered);
};

</script>
</body>
</html>
