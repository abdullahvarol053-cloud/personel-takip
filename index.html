<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personel Takip (FINAL - Auto Kolon + Beyaz)</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --txt:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);
      --btn:#2563eb;
      --btn2:#eef2ff;
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:14px;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.88);border-bottom:1px solid var(--line);backdrop-filter:blur(10px)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    h1{margin:0;font-size:16px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;background:rgba(15,23,42,.02)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--card),#fbfcff);border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(15,23,42,.14);background:#fff;color:var(--txt);outline:none}
    input:focus,select:focus,textarea:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    textarea{min-height:88px;resize:vertical}
    .btn{border:0;cursor:pointer;padding:10px 12px;border-radius:12px;color:white;background:var(--btn);font-weight:800;font-size:13px}
    .btn.secondary{background:var(--btn2);border:1px solid rgba(37,99,235,.20);color:#1e40af}
    .btn.danger{background:var(--danger)}
    .btn.ok{background:var(--ok)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .mini{font-size:12px;padding:8px 10px;border-radius:10px}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);font-size:12px;vertical-align:top}
    .table th{font-weight:900;background:rgba(15,23,42,.03);text-align:left}
    .table tr:hover td{background:rgba(37,99,235,.04)}
    .right{text-align:right}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);background:rgba(15,23,42,.02)}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--danger)}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:14px;box-shadow:0 18px 60px rgba(15,23,42,.15);display:none;max-width:min(92vw,780px);z-index:99}
    .toast.show{display:block}
    .toast b{font-size:13px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid var(--line);background:rgba(15,23,42,.02);color:#0f172a}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.two{grid-template-columns:1fr}}
    .hide{display:none!important}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>Personel Takip</h1>
      <span class="pill" id="statusPill">Durum: ‚Äî</span>
      <span class="pill">Limit: <b>5000</b></span>
      <div class="spacer"></div>
      <button class="btn secondary mini" id="btnSync">Sunucudan Senkronize Et</button>
      <button class="btn secondary mini" id="btnAdmin">Admin</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">
        Arama: <span class="kbd">personel</span> + <span class="kbd">not</span> |
        Tarih: <span class="kbd">ba≈ülangƒ±√ß</span>‚Äì<span class="kbd">biti≈ü</span> (g√ºn sonu dahil)
      </span>
      <div class="spacer"></div>
      <span class="muted" id="colsInfo">Kolonlar: ‚Äî</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="card">
      <h2>Yeni Hareket</h2>

      <div class="two">
        <div>
          <label>Personel</label>
          <select id="selPersonel"></select>
          <div class="muted" style="margin-top:6px">Personel yoksa Admin‚Äôden ekleyin.</div>
        </div>
        <div>
          <label>Tarih / Saat</label>
          <input id="inpDT" type="datetime-local" />
          <div class="muted" style="margin-top:6px">Bo≈ü bƒ±rakƒ±rsan ‚Äú≈üimdi‚Äù kaydeder.</div>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>T√ºr</label>
          <select id="selTip">
            <option value="GIRIS">Giri≈ü</option>
            <option value="CIKIS">√áƒ±kƒ±≈ü</option>
            <option value="NOT">Not</option>
          </select>
        </div>
        <div>
          <label>Etiket (opsiyonel)</label>
          <input id="inpEtiket" placeholder="√∂rn: Servis / Ge√ß / ƒ∞zin" />
          <div class="muted" style="margin-top:6px">Etiket not i√ßine eklenir.</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Not (opsiyonel)</label>
        <textarea id="inpNot" placeholder="Bu not aramada √ßƒ±kar (personel + not)."></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnKaydet">Kaydet</button>
        <button class="btn secondary" id="btnTemizle">Temizle</button>
        <div class="spacer"></div>
        <span class="tag" id="liveTag"><span class="dot warn"></span>Bekliyor</span>
      </div>

      <div class="hr"></div>

      <h2>Liste / Filtre</h2>

      <div class="two">
        <div>
          <label>Arama (personel adƒ± + not i√ßinde)</label>
          <input id="inpAra" placeholder="√∂rn: s√ºleyman / ge√ß kaldƒ± / izin" />
        </div>
        <div>
          <label>Personel se√ß (opsiyonel)</label>
          <select id="selFilterPersonel"></select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Ba≈ülangƒ±√ß (g√ºn ba≈üƒ±)</label>
          <input id="inpStart" type="date" />
        </div>
        <div>
          <label>Biti≈ü (g√ºn sonu dahil)</label>
          <input id="inpEnd" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnUygula">Uygula</button>
        <button class="btn secondary" id="btnSifirla">Sƒ±fƒ±rla</button>
        <div class="spacer"></div>
        <button class="btn secondary" id="btnExport">Excel (XLSX) Dƒ±≈üa Ver</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Not: Listeleme ve export maksimum <b>5000</b> kayƒ±t √ßeker (trafik d√º≈ü√ºk).
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h2 style="margin:0">Hareketler</h2>
        <div class="spacer"></div>
        <span class="pill" id="countPill">0 kayƒ±t</span>
      </div>

      <div style="margin-top:10px; overflow:auto; max-height:65vh">
        <table class="table">
          <thead>
            <tr>
              <th style="min-width:140px">Tarih</th>
              <th style="min-width:130px">Personel</th>
              <th style="min-width:90px">T√ºr</th>
              <th>Not</th>
              <th class="right" style="min-width:110px">ƒ∞≈ülem</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn secondary mini" id="btnPrev">‚Üê √ñnceki</button>
        <button class="btn secondary mini" id="btnNext">Sonraki ‚Üí</button>
        <div class="spacer"></div>
        <span class="muted">Sayfa: <b id="pageInfo">1</b></span>
      </div>
    </section>

  </div>
</main>

<!-- ADMIN MODAL -->
<div id="adminModal" class="toast" style="top:70px; bottom:auto; transform:translateX(-50%);">
  <div class="row">
    <b>Admin</b>
    <div class="spacer"></div>
    <button class="btn secondary mini" id="btnAdminClose">Kapat</button>
  </div>
  <div class="muted" style="margin-top:6px">PIN ile giri≈ü. (PIN ekranda yazmaz.)</div>

  <div class="hr"></div>

  <div id="adminLocked">
    <label>Admin PIN</label>
    <input id="adminPin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnAdminLogin">Giri≈ü</button>
      <span class="muted">Yanlƒ±≈ü deneme: <b id="pinTry">0</b></span>
      <div class="spacer"></div>
      <span class="muted">ƒ∞lk kurulum localStorage</span>
    </div>
    <div class="muted" style="margin-top:8px">
      Konsolda 1 kere: <span class="kbd">localStorage.setItem('ADMIN_PIN','070707')</span>
    </div>
  </div>

  <div id="adminUnlocked" class="hide">
    <div class="row">
      <span class="tag"><span class="dot ok"></span>Admin aktif</span>
      <div class="spacer"></div>
      <button class="btn secondary mini" id="btnAdminLogout">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px; font-size:13px">Personel Y√∂netimi</h3>
    <div class="two">
      <div>
        <label>Yeni personel adƒ±</label>
        <input id="inpNewPersonel" placeholder="√∂rn: S√ºleyman" />
      </div>
      <div style="display:flex; gap:10px; align-items:flex-end">
        <button class="btn ok" id="btnAddPersonel" style="width:100%">Ekle</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn danger mini" id="btnDelPersonel">Se√ßili personeli sil</button>
      <span class="muted">FK varsa Supabase engeller.</span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px; font-size:13px">Yedek / Geri Y√ºkle</h3>
    <div class="row">
      <button class="btn secondary mini" id="btnBackup">JSON ƒ∞ndir</button>
      <label class="btn secondary mini" style="cursor:pointer; display:inline-flex; align-items:center; gap:8px">
        JSON Y√ºkle
        <input id="fileRestore" type="file" accept="application/json" style="display:none" />
      </label>
      <div class="spacer"></div>
      <span class="muted" id="restoreReport">‚Äî</span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px; font-size:13px">Temizlik</h3>
    <div class="row">
      <button class="btn danger mini" id="btnDeleteRow">Se√ßili satƒ±rƒ± sil</button>
      <span class="muted">Listeden ‚ÄúSil‚Äù de olur.</span>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <b id="toastTitle">‚Äî</b>
  <div class="muted" id="toastMsg">‚Äî</div>
</div>

<script>
/* =========================
   üîß AYARLAR
========================= */
const LIMIT = 5000;
const PAGE_SIZE = 100;

// ‚úÖ Supabase Config (BURAYI DOLDUR)
const SUPABASE_URL = "https://ngnpocqaznpuggsvwbif.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec";

// ‚úÖ Tablo adlarƒ±
const TBL_PERSONEL = "personeller";
const TBL_HAREKET  = "hareketler";

// ‚úÖ Kolon adaylarƒ± (AUTO bulacak)
const CAND = {
  hareket: {
    id:   ["id"],
    pid:  ["personel_id","personelId","pid","personel_uuid","personel"],
    type: ["tur","tip","type","islem","hareket_turu"],
    note: ["not","aciklama","note","mesaj","yorum"],
    date: ["tarih","created_at","createdAt","zaman","datetime","tarih_saat","ts"]
  },
  personel: {
    id:   ["id"],
    name: ["ad","name","isim","personel","personel_ad"]
  }
};

const STORAGE = {
  ADMIN_PIN: "ADMIN_PIN",
  ADMIN_OK: "ADMIN_OK",
  LAST_FILTERS: "LAST_FILTERS",
  CACHE_PERSONEL: "CACHE_PERSONEL"
};

let supa = null;
let COLS = { hid:null, hpid:null, htype:null, hnote:null, hdate:null, pid:null, pname:null };

let personelList = [];
let rows = [];
let page = 1;
let selectedRowId = null;
let pinTry = 0;

const $ = (id)=>document.getElementById(id);

function toast(title,msg){
  $("toastTitle").textContent = title || "Bilgi";
  $("toastMsg").textContent = msg || "";
  $("toast").classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> $("toast").classList.remove("show"), 2600);
}

function setStatus(text, ok=true){
  $("statusPill").textContent = `Durum: ${text}`;
  $("liveTag").innerHTML = ok ? `<span class="dot ok"></span>Baƒülƒ±` : `<span class="dot warn"></span>${text}`;
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function fmtDT(iso){
  try{
    const d = new Date(iso);
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{ return iso || ""; }
}

function startOfDayISO(dateStr){
  if(!dateStr) return null;
  return new Date(dateStr + "T00:00:00").toISOString();
}
function endOfDayISO(dateStr){
  if(!dateStr) return null;
  return new Date(dateStr + "T23:59:59.999").toISOString();
}

async function colExists(table, col){
  // 0-1 satƒ±r d√∂ner; kolon yoksa Supabase "column does not exist" verir.
  const { error } = await supa.from(table).select(col).limit(1);
  return !error;
}

async function pickCol(table, list){
  for(const c of list){
    const ok = await colExists(table, c);
    if(ok) return c;
  }
  return null;
}

async function detectColumns(){
  COLS.hid   = await pickCol(TBL_HAREKET,  CAND.hareket.id);
  COLS.hpid  = await pickCol(TBL_HAREKET,  CAND.hareket.pid);
  COLS.htype = await pickCol(TBL_HAREKET,  CAND.hareket.type);
  COLS.hnote = await pickCol(TBL_HAREKET,  CAND.hareket.note);
  COLS.hdate = await pickCol(TBL_HAREKET,  CAND.hareket.date);

  COLS.pid   = await pickCol(TBL_PERSONEL, CAND.personel.id);
  COLS.pname = await pickCol(TBL_PERSONEL, CAND.personel.name);

  $("colsInfo").textContent =
    `Kolonlar: hareket(${COLS.hdate||"?"}/${COLS.htype||"?"}/${COLS.hnote||"?"}) personel(${COLS.pname||"?"})`;

  // Kritik kolonlar yoksa uyar
  if(!COLS.hpid){
    toast("Kolon Uyarƒ±sƒ±", "Hareket tablosunda personel_id benzeri kolon bulunamadƒ±.");
  }
  if(!COLS.hdate){
    toast("Kolon Uyarƒ±sƒ±", "Tarih kolonu bulunamadƒ± (tarih/created_at/zaman...). Tarih filtresi √ßalƒ±≈ümaz.");
  }
}

function loadFiltersFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE.LAST_FILTERS);
    if(!raw) return;
    const f = JSON.parse(raw);
    $("inpAra").value = f.q || "";
    $("inpStart").value = f.start || "";
    $("inpEnd").value = f.end || "";
  }catch{}
}
function saveFiltersToStorage(){
  const f = {
    q: $("inpAra").value.trim(),
    p: $("selFilterPersonel").value || "",
    start: $("inpStart").value || "",
    end: $("inpEnd").value || ""
  };
  localStorage.setItem(STORAGE.LAST_FILTERS, JSON.stringify(f));
}
function resetFilters(){
  $("inpAra").value = "";
  $("inpStart").value = "";
  $("inpEnd").value = "";
  $("selFilterPersonel").value = "";
  saveFiltersToStorage();
}

function fillPersonelSelects(){
  const withAll = (all)=>{
    const arr=[];
    if(all) arr.push(`<option value="">(Hepsi)</option>`);
    if(!personelList.length) arr.push(`<option value="" disabled selected>Personel yok</option>`);
    for(const p of personelList){
      arr.push(`<option value="${p[COLS.pid]}">${escapeHtml(p[COLS.pname]||"")}</option>`);
    }
    return arr.join("");
  };
  $("selPersonel").innerHTML = withAll(false);
  $("selFilterPersonel").innerHTML = withAll(true);

  try{
    const f = JSON.parse(localStorage.getItem(STORAGE.LAST_FILTERS) || "{}");
    if(f.p) $("selFilterPersonel").value = f.p;
  }catch{}
}

async function loadPersonel(force=false){
  const cacheOk = !force && localStorage.getItem(STORAGE.CACHE_PERSONEL);
  if(cacheOk){
    try{
      personelList = JSON.parse(localStorage.getItem(STORAGE.CACHE_PERSONEL)) || [];
      fillPersonelSelects();
      return;
    }catch{}
  }

  if(!supa || !COLS.pname){
    personelList = [];
    fillPersonelSelects();
    return;
  }

  const { data, error } = await supa.from(TBL_PERSONEL).select("*").order(COLS.pname, {ascending:true});
  if(error){
    toast("Personel", error.message);
    personelList = [];
  }else{
    personelList = data || [];
    localStorage.setItem(STORAGE.CACHE_PERSONEL, JSON.stringify(personelList));
  }
  fillPersonelSelects();
}

function clearForm(){
  $("inpDT").value="";
  $("selTip").value="GIRIS";
  $("inpEtiket").value="";
  $("inpNot").value="";
}

function isAdmin(){ return localStorage.getItem(STORAGE.ADMIN_OK)==="1"; }

async function saveHareket(){
  if(!supa) return toast("Supabase", "Baƒülantƒ± yok. URL/KEY doldur.");
  if(!COLS.hpid) return toast("Kolon", "personel_id kolonu bulunamadƒ±.");

  const pid = $("selPersonel").value;
  if(!pid) return toast("Eksik", "Personel se√ß.");

  const tur = $("selTip").value;
  const etiket = $("inpEtiket").value.trim();
  const notRaw = $("inpNot").value.trim();
  const not = (etiket ? `#${etiket} ` : "") + (notRaw || "");

  const dt = $("inpDT").value;
  const tarihIso = dt ? new Date(dt).toISOString() : new Date().toISOString();

  // Eƒüer TYPE kolonu yoksa, t√ºr√º not i√ßine yazƒ±p yine kaydedelim
  const payload = {
    [COLS.hpid]: pid
  };
  if(COLS.htype) payload[COLS.htype] = tur; else payload[COLS.hnote || "not"] = `[${tur}] ` + not;
  if(COLS.hnote) payload[COLS.hnote] = not || null;
  if(COLS.hdate) payload[COLS.hdate] = tarihIso;

  $("btnKaydet").disabled = true;
  try{
    const { error } = await supa.from(TBL_HAREKET).insert(payload);
    if(error) throw error;
    toast("Kayƒ±t", "Kaydedildi ‚úÖ");
    clearForm();
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
    setStatus("Kayƒ±t hatasƒ±", false);
  }finally{
    $("btnKaydet").disabled = false;
  }
}

async function applyFilters(force=false){
  saveFiltersToStorage();
  if(!supa) { rows=[]; renderTable(); return setStatus("Supabase ayarƒ± yok", false); }

  const q = $("inpAra").value.trim().toLowerCase();
  const personelFilter = $("selFilterPersonel").value || "";
  const start = $("inpStart").value;
  const end = $("inpEnd").value;

  if(force){
    await detectColumns();
    await loadPersonel(true);
  }

  const pmap = new Map((personelList||[]).map(p=>[p[COLS.pid], p[COLS.pname] || ""]));

  let query = supa.from(TBL_HAREKET).select("*").limit(LIMIT);

  // Tarih kolonu varsa filtre uygula
  const startIso = COLS.hdate ? startOfDayISO(start) : null;
  const endIso   = COLS.hdate ? endOfDayISO(end) : null;

  if(COLS.hdate){
    if(startIso) query = query.gte(COLS.hdate, startIso);
    if(endIso) query = query.lte(COLS.hdate, endIso);
    query = query.order(COLS.hdate, {ascending:false});
  }else{
    // tarih yoksa en azƒ±ndan id varsa id ile sƒ±ralayalƒ±m
    if(COLS.hid) query = query.order(COLS.hid, {ascending:false});
  }

  if(personelFilter && COLS.hpid) query = query.eq(COLS.hpid, personelFilter);

  $("btnUygula").disabled = true;
  $("btnSifirla").disabled = true;

  try{
    const { data, error } = await query;
    if(error) throw error;

    const raw = data || [];

    rows = q ? raw.filter(r=>{
      const ad = (pmap.get(r[COLS.hpid]) || "").toLowerCase();
      const note = (COLS.hnote ? (r[COLS.hnote] || "") : "").toLowerCase();
      const type = (COLS.htype ? (r[COLS.htype] || "") : "").toLowerCase();
      return ad.includes(q) || note.includes(q) || type.includes(q);
    }) : raw;

    renderTable(pmap);
    setStatus("Hazƒ±r", true);
  }catch(e){
    toast("Hata", e.message);
    setStatus("Listeleme hatasƒ±", false);
  }finally{
    $("btnUygula").disabled = false;
    $("btnSifirla").disabled = false;
  }
}

function renderTable(pmapOverride){
  const pmap = pmapOverride || new Map((personelList||[]).map(p=>[p[COLS.pid], p[COLS.pname] || ""]));
  const total = rows.length;
  $("countPill").textContent = `${total} kayƒ±t`;

  const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(page > maxPage) page = maxPage;
  $("pageInfo").textContent = `${page} / ${maxPage}`;

  const startIdx = (page-1)*PAGE_SIZE;
  const slice = rows.slice(startIdx, startIdx+PAGE_SIZE);

  const html = slice.map(r=>{
    const id = COLS.hid ? r[COLS.hid] : "";
    const ad = pmap.get(r[COLS.hpid]) || "‚Äî";
    const tip = COLS.htype ? (r[COLS.htype] || "‚Äî") : "‚Äî";
    const not = COLS.hnote ? (r[COLS.hnote] || "") : "";
    const t = COLS.hdate ? r[COLS.hdate] : "";
    return `
      <tr data-id="${escapeHtml(id)}">
        <td>${escapeHtml(fmtDT(t))}</td>
        <td>${escapeHtml(ad)}</td>
        <td>${escapeHtml(tip)}</td>
        <td>${escapeHtml(not)}</td>
        <td class="right">
          <button class="btn secondary mini" onclick="window.__pickRow('${escapeHtml(id)}')">Se√ß</button>
          <button class="btn danger mini" onclick="window.__deleteRow('${escapeHtml(id)}')">Sil</button>
        </td>
      </tr>
    `;
  }).join("");

  $("tbody").innerHTML = html || `<tr><td colspan="5" class="muted">Kayƒ±t yok.</td></tr>`;
}

window.__pickRow = (id)=>{ selectedRowId = id; toast("Se√ßildi", "Satƒ±r se√ßildi ‚úÖ"); };
window.__deleteRow = async (id)=>{ if(!isAdmin()) return toast("Yetki","Silmek i√ßin Admin giri≈üi gerekli."); await deleteRow(id); };

async function deleteRow(id){
  if(!supa) return toast("Supabase","Baƒülantƒ± yok.");
  if(!id) return toast("Sil","Satƒ±r id yok.");
  if(!COLS.hid) return toast("Kolon","id kolonu bulunamadƒ±.");

  if(!confirm("Bu satƒ±r silinsin mi?")) return;
  try{
    const { error } = await supa.from(TBL_HAREKET).delete().eq(COLS.hid, id);
    if(error) throw error;
    toast("Sil","Silindi ‚úÖ");
    selectedRowId=null;
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

/* =========================
   üîê ADMIN
========================= */
function openAdmin(show){
  const m = $("adminModal");
  if(show){
    m.classList.add("show");
    const ok = isAdmin();
    $("adminLocked").classList.toggle("hide", ok);
    $("adminUnlocked").classList.toggle("hide", !ok);
    $("pinTry").textContent = String(pinTry);
  }else m.classList.remove("show");
}
function adminLogin(){
  const pin = $("adminPin").value || "";
  const real = localStorage.getItem(STORAGE.ADMIN_PIN) || "";
  if(!real){ pinTry++; $("pinTry").textContent=String(pinTry); return toast("Admin","ADMIN_PIN ayarlƒ± deƒüil."); }
  if(pin===real){
    localStorage.setItem(STORAGE.ADMIN_OK,"1");
    $("adminPin").value="";
    toast("Admin","Giri≈ü ba≈üarƒ±lƒ± ‚úÖ");
    openAdmin(true);
  }else{
    pinTry++; $("pinTry").textContent=String(pinTry);
    toast("Admin","PIN yanlƒ±≈ü.");
  }
}
function adminLogout(){
  localStorage.removeItem(STORAGE.ADMIN_OK);
  toast("Admin","√áƒ±kƒ±≈ü yapƒ±ldƒ±.");
  openAdmin(true);
}

async function addPersonel(){
  if(!isAdmin()) return toast("Yetki","Admin gerekli.");
  if(!supa) return toast("Supabase","Baƒülantƒ± yok.");
  if(!COLS.pname) return toast("Kolon","Personel ad kolonu bulunamadƒ±.");

  const ad = $("inpNewPersonel").value.trim();
  if(!ad) return toast("Eksik","Personel adƒ± yaz.");

  try{
    const payload = { [COLS.pname]: ad };
    const { error } = await supa.from(TBL_PERSONEL).insert(payload);
    if(error) throw error;
    $("inpNewPersonel").value="";
    toast("Personel","Eklendi ‚úÖ");
    await loadPersonel(true);
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

async function delPersonel(){
  if(!isAdmin()) return toast("Yetki","Admin gerekli.");
  if(!supa) return toast("Supabase","Baƒülantƒ± yok.");
  if(!COLS.pid) return toast("Kolon","Personel id kolonu bulunamadƒ±.");

  const id = $("selPersonel").value;
  if(!id) return toast("Eksik","Silmek i√ßin personel se√ß.");
  if(!confirm("Se√ßili personel silinsin mi?")) return;

  try{
    const { error } = await supa.from(TBL_PERSONEL).delete().eq(COLS.pid, id);
    if(error) throw error;
    toast("Personel","Silindi ‚úÖ");
    await loadPersonel(true);
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

async function backupJSON(){
  if(!isAdmin()) return toast("Yetki","Admin gerekli.");
  if(!supa) return toast("Supabase","Baƒülantƒ± yok.");

  try{
    toast("Yedek","√áekiliyor‚Ä¶");
    const { data: p, error: ep } = await supa.from(TBL_PERSONEL).select("*").limit(LIMIT);
    if(ep) throw ep;
    const { data: h, error: eh } = await supa.from(TBL_HAREKET).select("*").limit(LIMIT);
    if(eh) throw eh;

    const payload = { meta:{ createdAt:new Date().toISOString(), limit:LIMIT, cols:COLS }, personeller:p||[], hareketler:h||[] };
    const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`personel_takip_yedek_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    toast("Yedek","JSON indirildi ‚úÖ");
  }catch(e){
    toast("Hata", e.message);
  }
}

async function restoreJSON(evt){
  if(!isAdmin()) return toast("Yetki","Admin gerekli.");
  const file = evt.target.files?.[0]; evt.target.value="";
  if(!file) return;
  if(!supa) return toast("Supabase","Baƒülantƒ± yok.");

  try{
    const json = JSON.parse(await file.text());
    const p = Array.isArray(json.personeller) ? json.personeller : [];
    const h = Array.isArray(json.hareketler) ? json.hareketler : [];
    let okP=0, skipP=0, okH=0, skipH=0;

    toast("Geri Y√ºkle","Y√ºkleniyor‚Ä¶");

    for(const item of p){
      const nameVal = item[COLS.pname] || item.ad || item.name || item.isim;
      if(!nameVal) { skipP++; continue; }
      const { error } = await supa.from(TBL_PERSONEL).insert({ [COLS.pname]: nameVal });
      if(error) skipP++; else okP++;
      if(okP+skipP>=LIMIT) break;
    }

    await loadPersonel(true);
    const pmap = new Map(personelList.map(x=>[(x[COLS.pname]||"").toLowerCase(), x[COLS.pid]]));

    for(const item of h){
      let pid = item[COLS.hpid] || item.personel_id || item.personelId;
      const ad = (item.personel_ad || item.personelName || "").toString().trim().toLowerCase();
      if(ad && pmap.has(ad)) pid = pmap.get(ad);
      if(!pid){ skipH++; continue; }

      const payload = { [COLS.hpid]: pid };
      const tval = item[COLS.htype] || item.tur || item.tip || item.type || "NOT";
      const nval = item[COLS.hnote] || item.not || item.aciklama || item.note || null;
      const dval = item[COLS.hdate] || item.tarih || item.created_at || new Date().toISOString();

      if(COLS.htype) payload[COLS.htype] = tval;
      if(COLS.hnote) payload[COLS.hnote] = nval;
      if(COLS.hdate) payload[COLS.hdate] = dval;

      const { error } = await supa.from(TBL_HAREKET).insert(payload);
      if(error) skipH++; else okH++;
      if(okH+skipH>=LIMIT) break;
    }

    $("restoreReport").textContent = `Personel: +${okP} (atla:${skipP}) | Hareket: +${okH} (atla:${skipH})`;
    toast("Geri Y√ºkle","Bitti ‚úÖ");
    await applyFilters(true);
  }catch(e){
    toast("Hata", e.message);
  }
}

function exportXLSX(){
  try{
    if(!rows.length) return toast("Excel","Kayƒ±t yok.");
    const pmap = new Map(personelList.map(p=>[p[COLS.pid], p[COLS.pname] || ""]));
    const data = rows.slice(0, LIMIT).map(r=>({
      "Tarih": COLS.hdate ? fmtDT(r[COLS.hdate]) : "",
      "Personel": pmap.get(r[COLS.hpid]) || "",
      "T√ºr": COLS.htype ? (r[COLS.htype] || "") : "",
      "Not": COLS.hnote ? (r[COLS.hnote] || "") : ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Hareketler");
    XLSX.writeFile(wb, `personel_hareketleri_${new Date().toISOString().slice(0,10)}.xlsx`);
    toast("Excel","XLSX indirildi ‚úÖ");
  }catch(e){
    toast("Hata", e.message);
  }
}

/* =========================
   EVENTS + INIT
========================= */
function wire(){
  $("btnKaydet").addEventListener("click", saveHareket);
  $("btnTemizle").addEventListener("click", clearForm);
  $("btnUygula").addEventListener("click", async()=>{ page=1; await applyFilters(); });
  $("btnSifirla").addEventListener("click", async()=>{ resetFilters(); page=1; await applyFilters(); });
  $("btnPrev").addEventListener("click", ()=>{ if(page>1){ page--; renderTable(); } });
  $("btnNext").addEventListener("click", ()=>{
    const maxPage = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
    if(page < maxPage){ page++; renderTable(); }
  });
  $("btnSync").addEventListener("click", async()=>{
    toast("Senkron","Sunucudan √ßekiliyor‚Ä¶");
    await detectColumns();
    await loadPersonel(true);
    await applyFilters(true);
  });
  $("btnExport").addEventListener("click", exportXLSX);

  $("btnAdmin").addEventListener("click", ()=>openAdmin(true));
  $("btnAdminClose").addEventListener("click", ()=>openAdmin(false));
  $("btnAdminLogin").addEventListener("click", adminLogin);
  $("btnAdminLogout").addEventListener("click", adminLogout);

  $("btnAddPersonel").addEventListener("click", addPersonel);
  $("btnDelPersonel").addEventListener("click", delPersonel);

  $("btnBackup").addEventListener("click", backupJSON);
  $("fileRestore").addEventListener("change", restoreJSON);

  $("btnDeleteRow").addEventListener("click", ()=>{
    if(!selectedRowId) return toast("Sil","√ñnce listeden bir satƒ±r se√ß.");
    deleteRow(selectedRowId);
  });

  $("tbody").addEventListener("click",(e)=>{
    const tr = e.target.closest("tr"); if(!tr) return;
    selectedRowId = tr.getAttribute("data-id") || null;
  });

  $("inpAra").addEventListener("keydown", async(e)=>{
    if(e.key==="Enter"){ page=1; await applyFilters(); }
  });
}

(async function init(){
  wire();
  loadFiltersFromStorage();

  try{
    if(SUPABASE_URL.includes("YOUR_") || SUPABASE_ANON.includes("YOUR_")){
      setStatus("Supabase ayarƒ± yok", false);
      toast("Ayar","SUPABASE_URL ve SUPABASE_ANON doldur.");
      return;
    }
    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    setStatus("Baƒülantƒ± hazƒ±r", true);

    await detectColumns();
    await loadPersonel();
    await applyFilters();
  }catch(e){
    setStatus("Ba≈ülatma hatasƒ±", false);
    toast("Hata", e.message);
  }
})();
</script>
</body>
</html>
