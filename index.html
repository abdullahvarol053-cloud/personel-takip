<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personel Takip â€“ Supabase</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --pri:#2563eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --shadow: 0 12px 40px rgba(2,8,23,.10);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--pri);box-shadow:0 0 14px rgba(37,99,235,.35)}
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted);background:#fff}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{user-select:none;padding:8px 10px;border-radius:10px;border:1px solid var(--line);font-size:13px;color:var(--muted);cursor:pointer;background:#fff}
    .tab.active{background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.35);color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    label{font-size:12px;color:var(--muted)}
    input,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);
      background:#fff;color:var(--text);outline:none
    }
    textarea{min-height:90px;resize:vertical}
    button{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:#fff;color:var(--text);cursor:pointer
    }
    button:hover{border-color:#cbd5e1}
    .btnPri{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.35)}
    .btnOk{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.35)}
    .btnBad{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.35)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .small{font-size:11px;color:var(--muted)}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:#fff}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    th{background:#f8fafc;color:var(--muted);text-align:left}
    tr:hover td{background:#f8fafc}
    .kpiGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:980px){.kpiGrid{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:700;margin-top:6px}
    .statusBox{border:1px dashed #cbd5e1;border-radius:12px;padding:10px;background:#fff}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .toast{position:fixed;left:16px;bottom:16px;background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);max-width:560px;display:none}
    .toast.show{display:block}
    .toast b{display:block;margin-bottom:4px}
    code.inline{background:#f1f5f9;border:1px solid #e2e8f0;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>PERSONEL TAKÄ°P â€“ Supabase (Tek Sayfa)</h1>
          <div class="sub">CanlÄ± dinleme yok â€¢ Personel normalde veri Ã§ekmez â€¢ Cache + manuel senkronize</div>
        </div>
      </div>
      <div class="row">
        <span id="connPill" class="pill">BaÄŸlantÄ±: <b class="warn">Kontrol edilmedi</b></span>
        <button class="btnPri" id="btnPing">BaÄŸlantÄ±yÄ± Kontrol Et</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="tabs">
          <div class="tab active" id="tabPersonel">ğŸ‘· Personel</div>
          <div class="tab" id="tabAdmin">ğŸ› ï¸ Admin</div>
        </div>

        <!-- PERSONEL -->
        <div id="personelPane">
          <div class="hr"></div>

          <div class="row">
            <div style="flex:1">
              <label>Personel AdÄ± (Bu cihazda kaydolur)</label>
              <input id="inpPersonelAd" placeholder="Ã–rn: Serkan" />
            </div>
            <button class="btnPri" id="btnPersonelKaydet">Kaydet</button>
          </div>

          <div class="muted">
            Personel ekranÄ± <b>normalde Supabaseâ€™ten veri Ã§ekmez</b>. GeÃ§miÅŸ â€œcacheâ€ten gÃ¶sterilir.
            <br><span class="small">Cihaz deÄŸiÅŸtiyse veya geÃ§miÅŸ gÃ¶rÃ¼nmÃ¼yorsa â€œSenkronize Etâ€ kullanÄ±n.</span>
          </div>

          <div class="hr"></div>

          <label>Yeni Hareket / Not</label>
          <textarea id="inpNot" placeholder="BugÃ¼n yapÄ±lan iÅŸ / not..."></textarea>

          <div class="row">
            <button class="btnOk" id="btnKaydet">âœ… Kaydet (Supabase INSERT)</button>
            <button id="btnCacheGoster">ğŸ“¦ Cache GÃ¶ster</button>
            <button class="btnPri" id="btnPersonelSync">ğŸ”„ Senkronize Et</button>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between">
            <div class="muted">Cache kayÄ±t sayÄ±sÄ±: <b id="personelCacheCount">0</b></div>
            <div class="muted">Son senkron: <b id="personelLastSync">â€”</b></div>
          </div>

          <div style="margin-top:8px">
            <table>
              <thead>
                <tr><th style="width:160px">Tarih</th><th>Not</th></tr>
              </thead>
              <tbody id="tbodyPersonel"></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN -->
        <div id="adminPane" style="display:none">
          <div class="hr"></div>

          <div id="adminLoginCard" class="col">
            <div class="muted">Admin giriÅŸ (tek cihaz gibi). Åifreyi bilen girer.</div>
            <div class="row">
              <div style="flex:1">
                <label>Admin Åifre</label>
                <input id="inpAdminPass" type="password" placeholder="Åifre" autocomplete="current-password" />
              </div>
              <button class="btnPri" id="btnAdminLogin">GiriÅŸ</button>
            </div>
          </div>

          <div id="adminArea" style="display:none">
            <div class="row" style="justify-content:space-between">
              <span class="badge">Admin aktif</span>
              <button class="btnBad" id="btnAdminLogout">Ã‡Ä±kÄ±ÅŸ</button>
            </div>

            <div class="hr"></div>

            <div class="kpiGrid">
              <div class="kpi"><div class="t">Toplam Personel</div><div class="v" id="kpiP">0</div></div>
              <div class="kpi"><div class="t">Toplam Hareket</div><div class="v" id="kpiH">0</div></div>
              <div class="kpi"><div class="t">BugÃ¼n Hareket</div><div class="v" id="kpiToday">0</div></div>
              <div class="kpi"><div class="t">Bu Ay Hareket</div><div class="v" id="kpiMonth">0</div></div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btnPri" id="btnAdminRefresh">ğŸ”„ Manuel Yenile</button>
              <button class="btnPri" id="btnXlsx">ğŸ“„ Excel (.xlsx) Ä°ndir</button>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btnOk" id="btnBackup">ğŸ§· Yedek Al (JSON)</button>
              <input id="fileRestore" type="file" accept="application/json" style="display:none" />
              <button class="btnBad" id="btnRestorePick">â™»ï¸ Geri YÃ¼kle (JSON SeÃ§)</button>
            </div>

            <div class="muted" id="restoreReport" style="margin-top:8px">Geri yÃ¼kleme raporu burada gÃ¶rÃ¼necek.</div>

            <div class="hr"></div>

            <div class="row">
              <div style="flex:1">
                <label>Personel Ekle (Admin)</label>
                <input id="inpYeniPersonel" placeholder="Ã–rn: AyÅŸe Demir" />
              </div>
              <button class="btnOk" id="btnPersonelEkle">â• Ekle</button>
            </div>

            <div class="row">
              <div style="flex:1">
                <label>Hareketlerde filtre (personel adÄ± iÃ§erir)</label>
                <input id="inpFiltre" placeholder="Ã–rn: serkan" />
              </div>
              <button id="btnFiltreTemizle">Temizle</button>
            </div>

            <div style="margin-top:8px">
              <table>
                <thead>
                  <tr><th style="width:160px">Tarih</th><th style="width:190px">Personel</th><th>Not</th></tr>
                </thead>
                <tbody id="tbodyAdmin"></tbody>
              </table>
            </div>

            <div class="muted" style="margin-top:8px">Not: Admin ekranÄ± canlÄ± dinleme yapmaz. Yenile yeterlidir.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:700">Durum / Hata Paneli</div>
            <div class="muted">Burada net hata gÃ¶rÃ¼necek. Kaydetmiyorsa sebebi yazacak.</div>
          </div>
          <span class="pill">Ref: <b id="refShow">â€”</b></span>
        </div>

        <div class="hr"></div>

        <div class="statusBox">
          <div class="muted" id="statusLine">HazÄ±r. â€œBaÄŸlantÄ±yÄ± Kontrol Etâ€ ile baÅŸla.</div>
          <div class="hr"></div>
          <div class="small">
            Beklenen tablo/kolonlar:
            <br>â€¢ <code class="inline">hareketler</code>: <code class="inline">personel</code>, <code class="inline">not</code>
            <br>â€¢ <code class="inline">personeller</code>: <code class="inline">ad</code>, <code class="inline">aktif</code>
            <br><span class="warn">EÄŸer kolon isimleri farklÄ±ysa Supabase â€œcolumn does not existâ€ diyecek.</span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="muted">
          En sÄ±k sebep: <b>RLS/policy</b> yÃ¼zÃ¼nden INSERT yasak.
          <br>Supabaseâ€™te tabloya INSERT izni verince her ÅŸey dÃ¼zelir.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <b id="toastTitle">Bildirim</b>
    <div id="toastMsg" class="muted"></div>
  </div>

<script>
/**********************
 *  AYARLAR
 **********************/
const SUPABASE_REF = "ngnpocqaznpuggsvvbif";
const SUPABASE_URL = "https://ngnpocqaznpuggsvwbif.supabase.co";

// Senin anon key (repo public olduÄŸu iÃ§in bu zaten gÃ¶rÃ¼nÃ¼r; gÃ¼venlik RLS ile saÄŸlanÄ±r)
const SUPABASE_ANON_KEY = (`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec`).trim();

const ADMIN_PASS = "07";

// Tablo adlarÄ±
const T_PERSONELLER = "personeller";
const T_HAREKETLER  = "hareketler";

// Kolon adlarÄ± (Supabaseâ€™te farklÄ±ysa hata panelinde gÃ¶receksin)
const COL_P_AD   = "personel_id";
const COL_P_AKT  = "aktif";
const COL_H_PER  = "personel_id";
const COL_H_NOT  = "not_text";
const COL_H_TUR  = "tur";
const DEFAULT_TUR = "not";


/**********************
 *  UTIL
 **********************/
const $ = (id)=>document.getElementById(id);
$("refShow").textContent = SUPABASE_REF;

function toast(title,msg){
  $("toastTitle").textContent = title;
  $("toastMsg").textContent = msg;
  const t = $("toast");
  t.classList.add("show");
  clearTimeout(window.__tto);
  window.__tto = setTimeout(()=>t.classList.remove("show"), 3200);
}
function setStatus(msg, kind){
  $("statusLine").innerHTML = msg;
  if(kind==="ok") $("connPill").innerHTML = `BaÄŸlantÄ±: <b class="ok">OK</b>`;
  if(kind==="warn") $("connPill").innerHTML = `BaÄŸlantÄ±: <b class="warn">UyarÄ±</b>`;
  if(kind==="bad") $("connPill").innerHTML = `BaÄŸlantÄ±: <b class="bad">Hata</b>`;
}
function fmtTR(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("tr-TR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }catch(e){ return iso || "â€”"; }
}
function safeKey(s){
  return (s||"").toLowerCase().trim().replace(/\s+/g,"_").replace(/[^a-z0-9_Ä±ÄŸÃ¼ÅŸÃ¶Ã§Ä°ÄÃœÅÃ–Ã‡]/gi,"");
}
function uuidv4(){
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
    const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15);
    const v = c==="x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/**********************
 *  CACHE
 **********************/
const LS = {
  personelAd: "pt_personel_ad",
  cache: (ad)=> `pt_cache_${safeKey(ad)}`,
  lastSync: (ad)=> `pt_last_sync_${safeKey(ad)}`,
  adminOn: "pt_admin_on"
};

function getPersonelAd(){ return (localStorage.getItem(LS.personelAd)||"").trim(); }
function setPersonelAd(ad){ localStorage.setItem(LS.personelAd, (ad||"").trim()); }

function readCache(ad){
  try{
    const raw = localStorage.getItem(LS.cache(ad));
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function writeCache(ad, arr){
  localStorage.setItem(LS.cache(ad), JSON.stringify(arr));
  localStorage.setItem(LS.lastSync(ad), new Date().toISOString());
}
function getLastSyncISO(ad){ return localStorage.getItem(LS.lastSync(ad)) || ""; }

/**********************
 *  TABS (JS Ã§Ã¶kse bile Ã§alÄ±ÅŸsÄ±n diye en baÅŸta baÄŸlanÄ±yor)
 **********************/
function setTab(which){
  const isP = which==="personel";
  $("tabPersonel").classList.toggle("active", isP);
  $("tabAdmin").classList.toggle("active", !isP);
  $("personelPane").style.display = isP ? "" : "none";
  $("adminPane").style.display = !isP ? "" : "none";
  if(!isP) renderAdminLoginState();
}
$("tabPersonel").onclick = ()=>setTab("personel");
$("tabAdmin").onclick = ()=>setTab("admin");

/**********************
 *  LIB LOADER (CDN sorununu Ã§Ã¶zer)
 **********************/
async function loadScript(url){
  return new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src=url; s.async=true;
    s.onload=()=>resolve(true);
    s.onerror=()=>reject(new Error("load fail"));
    document.head.appendChild(s);
  });
}
async function ensureSupabase(){
  if(window.supabase && typeof window.supabase.createClient==="function") return true;
  const urls = [
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js",
    "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"
  ];
  for(const u of urls){
    try{ await loadScript(u); }catch(e){}
    if(window.supabase && typeof window.supabase.createClient==="function") return true;
  }
  return false;
}
async function ensureXLSX(){
  if(window.XLSX) return true;
  const urls = [
    "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"
  ];
  for(const u of urls){
    try{ await loadScript(u); }catch(e){}
    if(window.XLSX) return true;
  }
  return false;
}

/**********************
 *  SUPABASE INIT
 **********************/
let supa = null;

async function init(){
  renderPersonel();

  const okSupa = await ensureSupabase();
  const okXlsx = await ensureXLSX();

  if(!okSupa){
    supa = null;
    setStatus("âŒ Supabase kÃ¼tÃ¼phanesi yÃ¼klenemedi. (Adblock / CDN engeli olabilir) <br>â€¢ Adblock kapatÄ±p sayfayÄ± yenile: <b>Ctrl+F5</b>", "bad");
    toast("Kritik", "Supabase JS yÃ¼klenmedi. Butonlar sÄ±nÄ±rlÄ± Ã§alÄ±ÅŸÄ±r.");
    return;
  }

  supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  if(!okXlsx){
    toast("UyarÄ±", "XLSX kÃ¼tÃ¼phanesi yÃ¼klenmedi. Excel indirme Ã§alÄ±ÅŸmayabilir.");
  }

  setStatus("âœ… HazÄ±r. Åimdi â€œBaÄŸlantÄ±yÄ± Kontrol Etâ€e bas.", "warn");
}

document.addEventListener("DOMContentLoaded", init);

/**********************
 *  PING
 **********************/
$("btnPing").onclick = async ()=>{
  if(!supa){
    setStatus("âŒ Supabase hazÄ±r deÄŸil. CDN/Adblock sorunu var.", "bad");
    return;
  }
  try{
    const { error } = await supa.from(T_PERSONELLER).select(COL_P_AD).limit(1);
    if(error){
      setStatus("âš ï¸ Supabase eriÅŸti ama tablo/izin sorunu var: <br><b>"+escapeHtml(error.message)+"</b>", "warn");
      toast("UyarÄ±", error.message);
      return;
    }
    setStatus("âœ… BaÄŸlantÄ± OK. (Tablo eriÅŸimi var)", "ok");
    toast("BaÄŸlantÄ±", "OK âœ…");
  }catch(e){
    setStatus("âŒ BaÄŸlantÄ± hatasÄ±. Ä°nternet/CDN/Supabase eriÅŸimi yok.", "bad");
    toast("Hata", "BaÄŸlantÄ± kurulamadÄ±.");
  }
};

/**********************
 *  PERSONEL UI
 **********************/
function renderPersonel(){
  const ad = getPersonelAd();
  $("inpPersonelAd").value = ad;

  const cache = ad ? readCache(ad) : [];
  $("personelCacheCount").textContent = String(cache.length);

  const ls = getLastSyncISO(ad);
  $("personelLastSync").textContent = ls ? fmtTR(ls) : "â€”";

  const tb = $("tbodyPersonel");
  tb.innerHTML = "";

  if(!ad){
    tb.innerHTML = `<tr><td colspan="2" class="muted">Personel adÄ± kaydedilmedi.</td></tr>`;
    return;
  }

  const rows = cache.slice().sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));
  if(rows.length===0){
    tb.innerHTML = `<tr><td colspan="2" class="muted">Cache boÅŸ. KayÄ±t gir veya senkronize et.</td></tr>`;
    return;
  }
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${fmtTR(r.created_at||"")}</td><td>${escapeHtml(r.not||"")}</td>`;
    tb.appendChild(tr);
  }
}

$("btnPersonelKaydet").onclick = ()=>{
  const ad = ($("inpPersonelAd").value||"").trim();
  if(!ad){ toast("UyarÄ±","Personel adÄ± boÅŸ olamaz."); return; }
  setPersonelAd(ad);
  toast("Kaydedildi","Personel adÄ± bu cihaza kaydedildi âœ…");
  renderPersonel();
};

$("btnCacheGoster").onclick = ()=>renderPersonel();

$("btnKaydet").onclick = async ()=>{
  const ad = getPersonelAd();
  if(!ad){ toast("UyarÄ±","Ã–nce personel adÄ±nÄ± kaydet."); return; }
  const note = ($("inpNot").value||"").trim();
  if(!note){ toast("UyarÄ±","Not boÅŸ olamaz."); return; }

  // Cache'e her durumda yazalÄ±m (trafik mantÄ±ÄŸÄ±)
  const localRow = { id: uuidv4(), personel: ad, not: note, created_at: new Date().toISOString() };

  if(!supa){
    // Supabase yoksa sadece cache
    const cache = readCache(ad); cache.push(localRow); writeCache(ad, cache);
    $("inpNot").value="";
    setStatus("âš ï¸ Supabase yok (CDN/Adblock). KayÄ±t sadece cache'e gitti.", "warn");
    renderPersonel();
    return;
  }

  try{
   const payload = {};
payload[COL_H_PER] = ad;
payload[COL_H_TUR] = DEFAULT_TUR;
payload[COL_H_NOT] = note;


    const { error } = await supa.from(T_HAREKETLER).insert(payload);

    if(error){
      // Yine de cache'e yaz (personel offline mantÄ±ÄŸÄ±)
      const cache = readCache(ad); cache.push(localRow); writeCache(ad, cache);
      $("inpNot").value="";
      setStatus("âŒ Supabase INSERT reddetti: <b>"+escapeHtml(error.message)+"</b><br>âœ… Ama kayÄ±t cache'e yazÄ±ldÄ±.", "warn");
      toast("INSERT HatasÄ±", error.message);
      renderPersonel();
      return;
    }

    // Supabase OK + cache
    const cache = readCache(ad); cache.push(localRow); writeCache(ad, cache);
    $("inpNot").value="";
    setStatus("âœ… KayÄ±t Supabase'e yazÄ±ldÄ± ve cache'e eklendi.", "ok");
    toast("Kaydedildi","Supabase + cache âœ…");
    renderPersonel();
  }catch(e){
    const cache = readCache(ad); cache.push(localRow); writeCache(ad, cache);
    $("inpNot").value="";
    setStatus("âŒ Ä°nternet/Supabase hatasÄ±. âœ… KayÄ±t cache'e yazÄ±ldÄ±.", "warn");
    toast("Hata","Ä°nternet/Supabase hatasÄ±.");
    renderPersonel();
  }
};

$("btnPersonelSync").onclick = async ()=>{
  const ad = getPersonelAd();
  if(!ad){ toast("UyarÄ±","Ã–nce personel adÄ±nÄ± kaydet."); return; }
  if(!supa){ toast("Hata","Supabase hazÄ±r deÄŸil (CDN/Adblock)."); return; }

  try{
    const { data, error } = await supa
      .from(T_HAREKETLER)
      .select("id, "+COL_H_PER+", "+COL_H_NOT+", created_at")
      .eq(COL_H_PER, ad)
      .order("created_at",{ascending:false})
      .limit(5000);

    if(error){
      setStatus("âŒ Senkron reddedildi: <b>"+escapeHtml(error.message)+"</b>", "warn");
      toast("Senkron HatasÄ±", error.message);
      return;
    }

    const mapped = (data||[]).map(x=>({
      id: x.id,
      personel: x[COL_H_PER],
      not: x[COL_H_NOT],
      created_at: x.created_at || new Date().toISOString()
    }));

    writeCache(ad, mapped);
    setStatus("âœ… Senkron OK. Cache yenilendi.", "ok");
    toast("Senkronize","Tamam âœ…");
    renderPersonel();
  }catch(e){
    setStatus("âŒ Senkron hatasÄ± (internet/izin).", "bad");
    toast("Hata","Senkron baÅŸarÄ±sÄ±z.");
  }
};

/**********************
 *  ADMIN
 **********************/
function isAdminOn(){ return localStorage.getItem(LS.adminOn)==="1"; }
function setAdminOn(v){ localStorage.setItem(LS.adminOn, v ? "1":"0"); }

function renderAdminLoginState(){
  const on = isAdminOn();
  $("adminLoginCard").style.display = on ? "none" : "";
  $("adminArea").style.display = on ? "" : "none";
  if(on) adminRefresh();
}

$("btnAdminLogin").onclick = ()=>{
  const p = ($("inpAdminPass").value||"").trim();
  if(p!==ADMIN_PASS){ toast("HatalÄ± Åifre","Admin ÅŸifresi yanlÄ±ÅŸ."); return; }
  setAdminOn(true);
  $("inpAdminPass").value="";
  toast("Admin","GiriÅŸ OK âœ…");
  renderAdminLoginState();
};
$("btnAdminLogout").onclick = ()=>{
  setAdminOn(false);
  toast("Admin","Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.");
  renderAdminLoginState();
};

let ADMIN = { personeller: [], hareketler: [] };

$("btnAdminRefresh").onclick = adminRefresh;

async function adminRefresh(){
  if(!isAdminOn()) return;
  if(!supa){ setStatus("âŒ Supabase hazÄ±r deÄŸil. Admin veri Ã§ekemez.", "bad"); return; }

  try{
    const [pRes, hRes] = await Promise.all([
      supa.from(T_PERSONELLER).select("*").order(COL_P_AD,{ascending:true}).limit(5000),
      supa.from(T_HAREKETLER).select("id,"+COL_H_PER+","+COL_H_NOT+",created_at").order("created_at",{ascending:false}).limit(5000),
    ]);

    if(pRes.error){
      setStatus("âš ï¸ Personeller okunamadÄ±: <b>"+escapeHtml(pRes.error.message)+"</b>", "warn");
      toast("Admin", pRes.error.message);
    }
    if(hRes.error){
      setStatus("âš ï¸ Hareketler okunamadÄ±: <b>"+escapeHtml(hRes.error.message)+"</b>", "warn");
      toast("Admin", hRes.error.message);
    }

    ADMIN.personeller = pRes.data || [];
    ADMIN.hareketler  = hRes.data || [];

    renderKPIs();
    applyAdminFilter();
    toast("Admin","Yenilendi âœ…");
  }catch(e){
    setStatus("âŒ Admin yenileme hatasÄ±.", "bad");
    toast("Hata","Admin yenileme baÅŸarÄ±sÄ±z.");
  }
}

function renderKPIs(){
  const p = ADMIN.personeller || [];
  const h = ADMIN.hareketler || [];
  $("kpiP").textContent = String(p.length);
  $("kpiH").textContent = String(h.length);

  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth(), d=now.getDate();
  let cToday=0, cMonth=0;

  for(const it of h){
    const dt = new Date(it.created_at||0);
    if(!isFinite(dt)) continue;
    if(dt.getFullYear()===y && dt.getMonth()===m) cMonth++;
    if(dt.getFullYear()===y && dt.getMonth()===m && dt.getDate()===d) cToday++;
  }
  $("kpiToday").textContent = String(cToday);
  $("kpiMonth").textContent = String(cMonth);
}

function renderAdminTable(list){
  const tb = $("tbodyAdmin");
  tb.innerHTML="";
  if(!list || list.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="muted">KayÄ±t yok.</td></tr>`;
    return;
  }
  for(const r of list){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${fmtTR(r.created_at||"")}</td>
      <td>${escapeHtml(r[COL_H_PER] || r.personel || "")}</td>
      <td>${escapeHtml(r[COL_H_NOT] || r.not || "")}</td>`;
    tb.appendChild(tr);
  }
}

function applyAdminFilter(){
  const q = ($("inpFiltre").value||"").toLowerCase().trim();
  const list = ADMIN.hareketler || [];
  const filtered = q ? list.filter(x => String(x[COL_H_PER]||x.personel||"").toLowerCase().includes(q)) : list;
  renderAdminTable(filtered);
}

$("inpFiltre").addEventListener("input", applyAdminFilter);
$("btnFiltreTemizle").onclick = ()=>{ $("inpFiltre").value=""; applyAdminFilter(); };

$("btnPersonelEkle").onclick = async ()=>{
  if(!isAdminOn()) return;
  const ad = ($("inpYeniPersonel").value||"").trim();
  if(!ad){ toast("UyarÄ±","Personel adÄ± boÅŸ olamaz."); return; }
  if(!supa){ toast("Hata","Supabase hazÄ±r deÄŸil."); return; }

  try{
    const row = {};
    row[COL_P_AD] = ad;
    row[COL_P_AKT] = true;

    const { error } = await supa.from(T_PERSONELLER).insert(row);
    if(error){
      setStatus("âŒ Personel eklenemedi: <b>"+escapeHtml(error.message)+"</b>", "warn");
      toast("Ekleme HatasÄ±", error.message);
      return;
    }
    $("inpYeniPersonel").value="";
    toast("Personel","Eklendi âœ…");
    adminRefresh();
  }catch(e){
    setStatus("âŒ Personel ekleme hatasÄ±.", "bad");
    toast("Hata","Personel ekleme baÅŸarÄ±sÄ±z.");
  }
};

/**********************
 *  BACKUP / RESTORE
 **********************/
$("btnBackup").onclick = async ()=>{
  if(!isAdminOn()) return;
  if(!supa){ toast("Hata","Supabase hazÄ±r deÄŸil."); return; }
  if(!ADMIN.personeller.length && !ADMIN.hareketler.length) await adminRefresh();

  const payload = {
    meta:{ app:"personel-takip", version:1, created_at:new Date().toISOString(), supabase_ref:SUPABASE_REF },
    personeller: ADMIN.personeller || [],
    hareketler: ADMIN.hareketler || []
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json;charset=utf-8"});
  const fname = `personel_takip_yedek_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.json`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 400);
  toast("Yedek","JSON indirildi âœ…");
};

$("btnRestorePick").onclick = ()=>{
  if(!isAdminOn()) return;
  $("fileRestore").value="";
  $("fileRestore").click();
};

$("fileRestore").addEventListener("change", async (ev)=>{
  if(!isAdminOn()) return;
  if(!supa){ toast("Hata","Supabase hazÄ±r deÄŸil."); return; }
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;

  try{
    const json = JSON.parse(await f.text());
    const personeller = Array.isArray(json.personeller) ? json.personeller : [];
    const hareketler  = Array.isArray(json.hareketler) ? json.hareketler : [];

    let total = personeller.length + hareketler.length;
    let inserted=0, skipped=0, failed=0;

    $("restoreReport").innerHTML = `â³ BaÅŸladÄ±... Toplam: <b>${total}</b>`;

    for(const p of personeller){
      const row = { id: p.id || uuidv4() };
      row[COL_P_AD] = p[COL_P_AD] ?? p.ad ?? "";
      row[COL_P_AKT]= (p[COL_P_AKT]===undefined ? true : !!p[COL_P_AKT]);
      const r = await tryInsertSkip(T_PERSONELLER, row);
      if(r==="inserted") inserted++; else if(r==="skipped") skipped++; else failed++;
    }

    for(const h of hareketler){
      const row = { id: h.id || uuidv4() };
      row[COL_H_PER] = h[COL_H_PER] ?? h.personel ?? "";
      row[COL_H_NOT] = h[COL_H_NOT] ?? h.not ?? "";
      const r = await tryInsertSkip(T_HAREKETLER, row);
      if(r==="inserted") inserted++; else if(r==="skipped") skipped++; else failed++;
    }

    const msg = `âœ… Bitti. Toplam: ${total} â€¢ Eklenen: ${inserted} â€¢ Atlanan: ${skipped} â€¢ Hata: ${failed}`;
    $("restoreReport").innerHTML = msg;
    toast("Geri YÃ¼kle", msg);
    adminRefresh();
  }catch(e){
    $("restoreReport").innerHTML = `âŒ JSON hata: ${escapeHtml(e.message||String(e))}`;
    toast("Geri YÃ¼kle","JSON okunamadÄ±.");
  }
});

async function tryInsertSkip(table, row){
  try{
    const { error } = await supa.from(table).insert(row, { returning:"minimal" });
    if(!error) return "inserted";
    if(String(error.code)==="23505") return "skipped";
    const m=(error.message||"").toLowerCase();
    if(m.includes("duplicate")||m.includes("already exists")||m.includes("conflict")) return "skipped";
    return "failed";
  }catch(e){ return "failed"; }
}

/**********************
 *  XLSX
 **********************/
$("btnXlsx").onclick = async ()=>{
  if(!isAdminOn()) return;
  if(!window.XLSX){ toast("Hata","XLSX kÃ¼tÃ¼phanesi yÃ¼klenmedi."); return; }
  if(!ADMIN.hareketler.length) await adminRefresh();

  const rows = (ADMIN.hareketler||[]).slice().sort((a,b)=>(a.created_at||"").localeCompare(b.created_at||""));
  const data = rows.map(r=>({
    "Tarih": fmtTR(r.created_at||""),
    "Personel": r[COL_H_PER] || "",
    "Not": r[COL_H_NOT] || ""
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  ws["!cols"] = [{wch:18},{wch:22},{wch:60}];
  XLSX.utils.book_append_sheet(wb, ws, "Hareketler");
  XLSX.writeFile(wb, `personel_takip_rapor_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast("Excel","XLSX indirildi âœ…");
};

/**********************
 *  BOOT
 **********************/
renderAdminLoginState();
setTab("personel");
</script>
</body>
</html>
