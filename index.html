<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personel Takip â€“ Supabase (Tek Sayfa)</title>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --soft:#eff6ff;
      --soft2:#f8fafc;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, #dbeafe 0%, transparent 55%),
                  radial-gradient(1000px 500px at 90% 0%, #e0e7ff 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin-bottom:14px;
    }
    .title{
      display:flex;gap:10px;align-items:center;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--pri)}
    h1{font-size:18px;margin:0}
    .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      padding:8px 10px;border-radius:999px;
      box-shadow: 0 4px 14px rgba(2,6,23,.06);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:.12s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btnPri{
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      color:#fff;border:0;
    }
    .btnPri:hover{background: linear-gradient(180deg, #2563eb, #1d4ed8)}
    .btnOk{background:rgba(22,163,74,.08);border-color:rgba(22,163,74,.25)}
    .btnBad{background:rgba(220,38,38,.07);border-color:rgba(220,38,38,.25)}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHd{
      padding:12px 12px 0 12px;
    }
    .tabs{
      display:flex;gap:8px;align-items:center;
      padding:0 12px 12px 12px;
    }
    .tab{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      color:var(--muted);
      background:var(--soft2);
      user-select:none;
    }
    .tab.on{background:var(--soft);color:var(--text);border-color:#c7ddff}
    .body{padding:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:10px 11px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:10px;align-items:end}
    .row > *{flex:1}
    .row .btn{flex:0 0 auto}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .mini{
      display:flex;gap:10px;flex-wrap:wrap;
      font-size:12px;color:var(--muted);
      margin-top:8px;
    }
    .mini b{color:var(--text)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:800}
    .muted{color:var(--muted)}
    .rightCard .body{padding-top:8px}
    .statusBox{
      border:1px dashed #cbd5e1;
      background:#fff;
      border-radius:14px;
      padding:12px;
      font-size:13px;
      line-height:1.35;
    }
    .statusLine{display:flex;gap:10px;align-items:flex-start;margin:6px 0}
    .badge{
      font-size:12px;font-weight:800;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft2);
    }
    .badge.ok{background:rgba(22,163,74,.09);border-color:rgba(22,163,74,.22);color:#14532d}
    .badge.warn{background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.22);color:#7c2d12}
    .badge.bad{background:rgba(220,38,38,.09);border-color:rgba(220,38,38,.22);color:#7f1d1d}
    .cards4{
      display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:8px 0 10px;
    }
    @media(max-width:980px){ .cards4{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;
    }
    .kpi .t{font-size:12px;color:var(--muted);font-weight:800}
    .kpi .v{font-size:22px;font-weight:900;margin-top:2px}
    .hidden{display:none !important}
    .smallNote{font-size:12px;color:var(--muted);margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="title">
      <div class="dot"></div>
      <div>
        <h1>PERSONEL TAKÄ°P â€“ Supabase (Tek Sayfa)</h1>
        <div class="subtitle">CanlÄ± dinleme yok â€¢ Personel normalde veri Ã§ekmez â€¢ Cache + manuel senkronize â€¢ XLSX rapor + JSON yedek</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
      <div class="pill">BaÄŸlantÄ±: <b id="connState">Kontrol edilmedi</b></div>
      <button class="btn btnPri" id="btnPing">BaÄŸlantÄ±yÄ± Kontrol Et</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="cardHd">
        <div class="tabs">
          <div class="tab on" id="tabPersonel">ğŸ‘· Personel</div>
          <div class="tab" id="tabAdmin">ğŸ› ï¸ Admin</div>
        </div>
      </div>

      <div class="body">

        <!-- PERSONEL -->
        <div id="secPersonel">
          <label>Personel AdÄ± (Bu cihazda kaydolur)</label>
          <div class="row">
            <input id="inpPersonelAd" placeholder="Ã¶rn: sÃ¼leyman" />
            <button class="btn btnOk" id="btnSaveName">Kaydet</button>
          </div>

          <div class="hint">
            Personel ekranÄ± normalde Supabaseâ€™ten veri Ã§ekmez. GeÃ§miÅŸ â€œcacheâ€ten gÃ¶rÃ¼nÃ¼r.<br>
            Cihaz deÄŸiÅŸtiyse veya geÃ§miÅŸ gÃ¶rÃ¼nmÃ¼yorsa <b>Senkronize Et</b> kullanÄ±n.
          </div>

          <label>Yeni Hareket / Not</label>
          <textarea id="inpNot" placeholder="Ã¶rn: eve geldim / bakÄ±m yapÄ±ldÄ± / izin"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn btnPri" id="btnKaydet">âœ… Kaydet (Supabase INSERT)</button>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCacheShow">ğŸ“¦ Cache GÃ¶ster</button>
            <button class="btn" id="btnSync">ğŸ”„ Senkronize Et</button>
          </div>

          <div class="mini">
            <div>Cache kayÄ±t sayÄ±sÄ±: <b id="personelCacheCount">0</b></div>
            <div>Son senkron: <b id="personelLastSync">â€”</b></div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Tarih BaÅŸlangÄ±Ã§</label>
              <input id="inpPFrom" type="date" />
            </div>
            <div>
              <label>Tarih BitiÅŸ</label>
              <input id="inpPTo" type="date" />
            </div>
            <button class="btn" id="btnPClearDate">Temizle</button>
          </div>

          <div class="hr"></div>

          <table>
            <thead>
              <tr><th style="width:145px">Tarih</th><th>Not</th></tr>
            </thead>
            <tbody id="tbodyPersonel">
              <tr><td colspan="2" class="muted">HenÃ¼z kayÄ±t yok.</td></tr>
            </tbody>
          </table>
        </div>

        <!-- ADMIN -->
        <div id="secAdmin" class="hidden">
          <div id="adminLoginBox">
            <label>Admin Åifre</label>
            <div class="row">
              <input id="inpAdminPass" type="password" placeholder="Åifre" />
              <button class="btn btnPri" id="btnAdminLogin">GiriÅŸ</button>
            </div>
            <div class="hint">Not: Bu ÅŸifre HTML iÃ§inde durur. AsÄ±l gÃ¼venlik iÃ§in Supabase RLS/policy Ã¶nerilir.</div>
          </div>

          <div id="adminPanel" class="hidden">
            <div class="row" style="align-items:center">
              <div class="pill" style="flex:1">Admin: <b>aktif</b></div>
              <button class="btn btnBad" id="btnAdminLogout">Ã‡Ä±kÄ±ÅŸ</button>
            </div>

            <div class="cards4">
              <div class="kpi"><div class="t">Toplam Personel</div><div class="v" id="kpiPersonel">0</div></div>
              <div class="kpi"><div class="t">Toplam Hareket (yÃ¼klÃ¼)</div><div class="v" id="kpiHareket">0</div></div>
              <div class="kpi"><div class="t">BugÃ¼n Hareket</div><div class="v" id="kpiToday">0</div></div>
              <div class="kpi"><div class="t">Bu Ay Hareket</div><div class="v" id="kpiMonth">0</div></div>
            </div>

            <div class="row">
              <button class="btn btnPri" id="btnAdminRefresh">ğŸ” Manuel Yenile</button>
              <button class="btn" id="btnXlsx">ğŸ“„ Excel (.xlsx) indir</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnBackup">ğŸ§· Yedek Al (JSON)</button>
              <label class="btn" style="text-align:center;cursor:pointer" for="fileRestore">â™»ï¸ Geri YÃ¼kle (JSON SeÃ§)</label>
              <input id="fileRestore" type="file" accept="application/json" class="hidden" />
            </div>
            <div class="smallNote" id="restoreReport">Geri yÃ¼kleme raporu burada gÃ¶rÃ¼necek.</div>

            <div class="hr"></div>

            <div class="row">
              <div style="flex:1">
                <label>Personel Ekle (Admin)</label>
                <input id="inpAddPersonel" placeholder="Ã–rn: AyÅŸe Demir" />
              </div>
              <div style="flex:1">
                <label>Opsiyonel Åifre</label>
                <input id="inpAddPersonelSifre" placeholder="(istersen)" />
              </div>
              <button class="btn btnOk" id="btnAddPersonel">â• Ekle</button>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div style="flex:1">
                <label>Personel filtresi (iÃ§erir)</label>
                <input id="inpFiltre" placeholder="Ã–rn: serkan" />
              </div>

              <div style="flex:1">
                <label>BaÅŸlangÄ±Ã§</label>
                <input id="inpAFrom" type="date" />
              </div>

              <div style="flex:1">
                <label>BitiÅŸ</label>
                <input id="inpATo" type="date" />
              </div>

              <button class="btn" id="btnFiltreTemizle">Temizle</button>
            </div>

            <table style="margin-top:10px">
              <thead>
                <tr>
                  <th style="width:145px">Tarih</th>
                  <th style="width:150px">Personel</th>
                  <th>Not</th>
                </tr>
              </thead>
              <tbody id="tbodyAdmin">
                <tr><td colspan="3" class="muted">YÃ¼klemek iÃ§in â€œManuel Yenileâ€ bas.</td></tr>
              </tbody>
            </table>

            <div class="hint">Not: Admin ekranÄ± canlÄ± dinleme yapmaz. Yenile yeterlidir.</div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="card rightCard">
      <div class="body">
        <div class="statusBox">
          <div class="statusLine">
            <span class="badge" id="badgeState">Bilgi</span>
            <div style="flex:1">
              <b>Durum / Hata Paneli</b><br>
              <span class="muted">Kaydetmiyorsa veya okunmuyorsa sebebi burada yazar.</span>
            </div>
            <span class="badge" id="refBadge">Ref: â€”</span>
          </div>

          <div class="hr"></div>

          <div id="logBox" class="muted">HazÄ±r.</div>

          <div class="hr"></div>

          <div class="muted">
            <b>Tablo/Kolon Beklentisi</b>
            <ul style="margin:6px 0 0 18px;padding:0">
              <li><b>hareketler</b>: <code>personel_id</code>, <code>tur</code>, <code>not_text</code>, <code>created_at</code></li>
              <li><b>personeller</b>: <code>ad_soyad</code>, <code>sifre</code> (opsiyonel)</li>
            </ul>
            <div style="margin-top:8px">Not: CSV TÃ¼rkÃ§e karakterlerde sorun Ã§Ä±karÄ±r â†’ XLSX kullanÄ±yoruz âœ…</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/*** =========================
 *  AYARLAR (tek yer)
 *  ========================= */
const SUPABASE_REF = "ngnpocqaznpuggsvvbif";
const SUPABASE_URL = `https://${SUPABASE_REF}.supabase.co`;

// Senin paylaÅŸtÄ±ÄŸÄ±n anon key (sondaki tÄ±rnak temizlendi)
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec";

// Admin ÅŸifre (Ctrl+F -> ADMIN_PASS)
const ADMIN_PASS = "2";

// Supabase tablolar
const T_HAREKETLER = "hareketler";
const COL_H_PER = "personel_id";
const COL_H_TUR = "tur";
const COL_H_NOT = "not_text";

// Admin personel listesi (sende tablo: personeller / kolon: ad_soyad, sifre)
const T_PERSONELLER = "personeller";
const COL_P_AD   = "ad_soyad";
const COL_P_SIFRE= "sifre";

/*** =========================
 *  YardÄ±mcÄ±lar
 *  ========================= */
const $ = (id)=>document.getElementById(id);

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function uid(){
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
    const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
function fmtTR(iso){
  try{
    const d = new Date(iso);
    if(!isFinite(d)) return String(iso||"");
    return d.toLocaleString("tr-TR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }catch{ return String(iso||""); }
}
function setBadge(type, text){
  const b = $("badgeState");
  b.className = "badge " + (type||"");
  b.textContent = text;
}
function log(msg, type){
  if(type==="ok") setBadge("ok","OK");
  else if(type==="warn") setBadge("warn","UyarÄ±");
  else if(type==="bad") setBadge("bad","Hata");
  else setBadge("","Bilgi");

  $("logBox").innerHTML = escapeHtml(msg).replace(/\n/g,"<br>");
}
function dateRangeMs(fromStr,toStr){
  let start=null,end=null;
  if(fromStr){
    const [y,m,d]=fromStr.split("-").map(Number);
    start=new Date(y,m-1,d,0,0,0,0).getTime();
  }
  if(toStr){
    const [y,m,d]=toStr.split("-").map(Number);
    end=new Date(y,m-1,d,23,59,59,999).getTime();
  }
  return {start,end};
}
function inRangeIso(iso,start,end){
  const t = new Date(iso||0).getTime();
  if(!isFinite(t)) return false;
  if(start!==null && t<start) return false;
  if(end!==null && t>end) return false;
  return true;
}

/*** =========================
 *  Supabase Client
 *  ========================= */
$("refBadge").textContent = "Ref: " + SUPABASE_REF;

const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
});

/*** =========================
 *  Cache (Personel)
 *  ========================= */
const LS = {
  personelName: "pt.personel.name",
  adminOk: "pt.admin.ok"
};

function cacheKey(name){ return `pt.cache.${name}`; }
function lastSyncKey(name){ return `pt.lastsync.${name}`; }

function getPersonelAd(){ return (localStorage.getItem(LS.personelName)||"").trim(); }
function setPersonelAd(v){ localStorage.setItem(LS.personelName, (v||"").trim()); }

function readCache(name){
  try{
    const raw = localStorage.getItem(cacheKey(name));
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function writeCache(name, arr){
  localStorage.setItem(cacheKey(name), JSON.stringify(arr || []));
}
function setLastSync(name, iso){
  localStorage.setItem(lastSyncKey(name), iso || "");
}
function getLastSyncISO(name){
  return localStorage.getItem(lastSyncKey(name)) || "";
}

/*** =========================
 *  UI: Sekmeler
 *  ========================= */
function showTab(which){
  const isP = which==="p";
  $("tabPersonel").classList.toggle("on", isP);
  $("tabAdmin").classList.toggle("on", !isP);
  $("secPersonel").classList.toggle("hidden", !isP);
  $("secAdmin").classList.toggle("hidden", isP);
}
$("tabPersonel").onclick = ()=>showTab("p");
$("tabAdmin").onclick = ()=>{
  showTab("a");
  syncAdminUiState();
};

/*** =========================
 *  BaÄŸlantÄ± Kontrol
 *  ========================= */
$("btnPing").onclick = async ()=>{
  try{
    $("connState").textContent = "Kontrol ediliyor...";
    const { error } = await supa.from(T_HAREKETLER).select("id").limit(1);
    if(error) throw error;
    $("connState").textContent = "OK";
    log("âœ… BaÄŸlantÄ± OK. Supabase eriÅŸimi var.", "ok");
  }catch(e){
    $("connState").textContent = "UyarÄ±";
    log("âŒ BaÄŸlantÄ± sorunu: " + (e?.message||e), "bad");
  }
};

/*** =========================
 *  PERSONEL ekranÄ±
 *  ========================= */
function renderPersonel(){
  const ad = getPersonelAd();
  $("inpPersonelAd").value = ad;

  if(!ad){
    $("personelCacheCount").textContent = "0";
    $("personelLastSync").textContent = "â€”";
    $("tbodyPersonel").innerHTML = `<tr><td colspan="2" class="muted">Personel adÄ± kaydedilmedi.</td></tr>`;
    return;
  }

  const cache = readCache(ad);
  const ls = getLastSyncISO(ad);
  $("personelLastSync").textContent = ls ? fmtTR(ls) : "â€”";

  const rows = cache.slice().sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));

  const fromStr = $("inpPFrom").value || "";
  const toStr   = $("inpPTo").value || "";
  const {start,end} = dateRangeMs(fromStr,toStr);

  const filtered = (start!==null || end!==null)
    ? rows.filter(r => inRangeIso(r.created_at, start, end))
    : rows;

  $("personelCacheCount").textContent = `${filtered.length}/${cache.length}`;

  const tb = $("tbodyPersonel");
  tb.innerHTML = "";
  if(filtered.length===0){
    tb.innerHTML = `<tr><td colspan="2" class="muted">Bu filtrede kayÄ±t yok.</td></tr>`;
    return;
  }
  for(const r of filtered){
    tb.insertAdjacentHTML("beforeend",
      `<tr><td>${escapeHtml(fmtTR(r.created_at||""))}</td><td>${escapeHtml(r.not_text ?? r.not ?? "")}</td></tr>`
    );
  }
}

$("btnSaveName").onclick = ()=>{
  const v = ($("inpPersonelAd").value||"").trim();
  if(!v){ log("âš ï¸ Personel adÄ± boÅŸ olamaz.", "warn"); return; }
  setPersonelAd(v);
  renderPersonel();
  log("âœ… Personel adÄ± kaydedildi. Bu cihaz artÄ±k bu isimle Ã§alÄ±ÅŸÄ±r.", "ok");
};

$("btnCacheShow").onclick = ()=>{
  renderPersonel();
  log("ğŸ“¦ Cache gÃ¶sterildi. (Supabase Ã§aÄŸrÄ±sÄ± yok)", "ok");
};

$("btnPClearDate").onclick = ()=>{
  $("inpPFrom").value="";
  $("inpPTo").value="";
  renderPersonel();
};

$("inpPFrom").addEventListener("change", renderPersonel);
$("inpPTo").addEventListener("change", renderPersonel);

$("btnKaydet").onclick = async ()=>{
  const ad = getPersonelAd();
  const note = ($("inpNot").value||"").trim();
  if(!ad){ log("âš ï¸ Ã–nce personel adÄ±nÄ± kaydet.", "warn"); return; }
  if(!note){ log("âš ï¸ Not boÅŸ olamaz.", "warn"); return; }

  // local kayÄ±t
  const localRow = {
    local_id: uid(),
    id: null,                    // supabase id (bigint) gelirse dolacak
    created_at: new Date().toISOString(),
    [COL_H_PER]: ad,
    [COL_H_TUR]: "not",
    [COL_H_NOT]: note
  };

  const cache = readCache(ad);
  cache.push(localRow);
  writeCache(ad, cache);
  $("inpNot").value = "";
  renderPersonel();

  // supabase INSERT (id gÃ¶ndermiyoruz!)
  try{
    const payload = {};
    payload[COL_H_PER] = ad;
    payload[COL_H_TUR] = "not";
    payload[COL_H_NOT] = note;

    const { data, error } = await supa
      .from(T_HAREKETLER)
      .insert(payload)
      .select("id,created_at")
      .single();

    if(error) throw error;

    // cache'teki son kaydÄ± id/created_at ile gÃ¼ncelle
    const newest = readCache(ad);
    const idx = newest.findIndex(x => x.local_id === localRow.local_id);
    if(idx>=0){
      newest[idx].id = data?.id ?? null;
      if(data?.created_at) newest[idx].created_at = data.created_at;
      writeCache(ad, newest);
      renderPersonel();
    }

    log("âœ… KayÄ±t Supabase'e yazÄ±ldÄ± ve cache'e eklendi.", "ok");
  }catch(e){
    log("âŒ Supabase INSERT reddetti: " + (e?.message||e) + "\nâœ… Ama kayÄ±t cache'e yazÄ±ldÄ±.", "warn");
  }
};

$("btnSync").onclick = async ()=>{
  const ad = getPersonelAd();
  if(!ad){ log("âš ï¸ Ã–nce personel adÄ±nÄ± kaydet.", "warn"); return; }

  try{
    log("ğŸ”„ Senkronize ediliyor... (Supabase'ten sadece bu personelin geÃ§miÅŸi Ã§ekilir)", "");
    const { data, error } = await supa
      .from(T_HAREKETLER)
      .select(`id,${COL_H_PER},${COL_H_TUR},${COL_H_NOT},created_at`)
      .eq(COL_H_PER, ad)
      .order("created_at", {ascending:false})
      .limit(5000);

    if(error) throw error;

    const remote = Array.isArray(data) ? data : [];

    // local pending'leri kaybetmeyelim: fingerprint ile merge
    const local = readCache(ad);
    const fp = (r)=> `${r[COL_H_PER]||""}|${r[COL_H_TUR]||""}|${r[COL_H_NOT]||""}|${r.created_at||""}`;
    const set = new Set(remote.map(fp));
    const pending = local.filter(x => !x.id).filter(x => !set.has(fp(x)));

    const merged = remote.concat(pending);
    writeCache(ad, merged);

    setLastSync(ad, new Date().toISOString());
    renderPersonel();
    log(`âœ… Senkron tamam. Supabase: ${remote.length} kayÄ±t â€¢ Cache'e taÅŸÄ±nan bekleyen: ${pending.length}`, "ok");
  }catch(e){
    log("âŒ Senkron baÅŸarÄ±sÄ±z: " + (e?.message||e), "bad");
  }
};

/*** =========================
 *  ADMIN ekranÄ±
 *  ========================= */
const ADMIN = { personeller: [], hareketler: [] };

function syncAdminUiState(){
  const ok = localStorage.getItem(LS.adminOk)==="1";
  $("adminLoginBox").classList.toggle("hidden", ok);
  $("adminPanel").classList.toggle("hidden", !ok);
}

$("btnAdminLogin").onclick = ()=>{
  const pass = ($("inpAdminPass").value||"").trim();
  if(pass !== ADMIN_PASS){
    log("âŒ Admin ÅŸifre yanlÄ±ÅŸ.", "bad");
    return;
  }
  localStorage.setItem(LS.adminOk,"1");
  $("inpAdminPass").value="";
  syncAdminUiState();
  log("âœ… Admin giriÅŸ baÅŸarÄ±lÄ±.", "ok");
};

$("btnAdminLogout").onclick = ()=>{
  localStorage.removeItem(LS.adminOk);
  syncAdminUiState();
  log("â„¹ï¸ Admin Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±.", "");
};

function adminFilteredList(){
  const q = ($("inpFiltre").value||"").toLowerCase().trim();
  const fromStr = $("inpAFrom").value || "";
  const toStr   = $("inpATo").value || "";
  const {start,end} = dateRangeMs(fromStr,toStr);

  let list = ADMIN.hareketler || [];
  if(q){
    list = list.filter(r => String(r[COL_H_PER]||"").toLowerCase().includes(q));
  }
  if(start!==null || end!==null){
    list = list.filter(r => inRangeIso(r.created_at, start, end));
  }
  return list;
}

function renderAdminTable(list){
  const tb = $("tbodyAdmin");
  tb.innerHTML = "";
  if(!list || list.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="muted">KayÄ±t yok.</td></tr>`;
    return;
  }
  for(const r of list){
    tb.insertAdjacentHTML("beforeend",
      `<tr>
        <td>${escapeHtml(fmtTR(r.created_at||""))}</td>
        <td>${escapeHtml(r[COL_H_PER]||"")}</td>
        <td>${escapeHtml(r[COL_H_NOT]||"")}</td>
      </tr>`
    );
  }
}

function updateKpis(){
  const all = ADMIN.hareketler || [];
  const today = new Date();
  const y=today.getFullYear(), m=today.getMonth();

  const isSameDay = (iso)=>{
    const d=new Date(iso||0);
    return isFinite(d) && d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate();
  };
  const isSameMonth = (iso)=>{
    const d=new Date(iso||0);
    return isFinite(d) && d.getFullYear()===y && d.getMonth()===m;
  };

  const uniqFromMoves = new Set(all.map(r=> String(r[COL_H_PER]||"").trim()).filter(Boolean)).size;

  const pcount = (ADMIN.personeller && ADMIN.personeller.length>0)
    ? ADMIN.personeller.length
    : uniqFromMoves;

  $("kpiPersonel").textContent = String(pcount);
  $("kpiHareket").textContent = String(all.length);
  $("kpiToday").textContent = String(all.filter(r=>isSameDay(r.created_at)).length);
  $("kpiMonth").textContent = String(all.filter(r=>isSameMonth(r.created_at)).length);
}

function applyAdminFilter(){
  renderAdminTable(adminFilteredList());
}

$("inpFiltre").addEventListener("input", applyAdminFilter);
$("inpAFrom").addEventListener("change", applyAdminFilter);
$("inpATo").addEventListener("change", applyAdminFilter);

$("btnFiltreTemizle").onclick = ()=>{
  $("inpFiltre").value="";
  $("inpAFrom").value="";
  $("inpATo").value="";
  applyAdminFilter();
};

$("btnAdminRefresh").onclick = async ()=>{
  try{
    log("ğŸ” Admin verileri Ã§ekiliyor... (manuel)", "");
    // personeller tablosu (ad_soyad, sifre)
    const pReq = supa.from(T_PERSONELLER).select(`${COL_P_AD},${COL_P_SIFRE}`).order(COL_P_AD,{ascending:true}).limit(5000);
    // hareketler tablosu
    const hReq = supa.from(T_HAREKETLER).select(`id,${COL_H_PER},${COL_H_TUR},${COL_H_NOT},created_at`).order("created_at",{ascending:false}).limit(5000);

    const [{data:pd, error:pe},{data:hd, error:he}] = await Promise.all([pReq,hReq]);
    if(pe) throw pe;
    if(he) throw he;

    ADMIN.personeller = Array.isArray(pd)? pd: [];
    ADMIN.hareketler  = Array.isArray(hd)? hd: [];

    updateKpis();
    applyAdminFilter();

    log(`âœ… Admin yenileme tamam. Personel listesi: ${ADMIN.personeller.length} â€¢ Hareket: ${ADMIN.hareketler.length}`, "ok");
  }catch(e){
    log("âŒ Admin yenileme hata: " + (e?.message||e), "bad");
  }
};

$("btnAddPersonel").onclick = async ()=>{
  const ad = ($("inpAddPersonel").value||"").trim();
  const sifre = ($("inpAddPersonelSifre").value||"").trim();
  if(!ad){ log("âš ï¸ Personel adÄ± boÅŸ olamaz.", "warn"); return; }

  try{
    const row = {};
    row[COL_P_AD] = ad;
    row[COL_P_SIFRE] = sifre || null;

    // aynÄ± ad varsa skip (Ã¶nce admin listede var mÄ± kontrol)
    if(ADMIN.personeller.some(x => String(x[COL_P_AD]||"").toLowerCase() === ad.toLowerCase())){
      log("â„¹ï¸ Bu personel zaten listede var. (AtlandÄ±)", "warn");
      return;
    }

    const { error } = await supa.from(T_PERSONELLER).insert(row);
    if(error) throw error;

    $("inpAddPersonel").value="";
    $("inpAddPersonelSifre").value="";

    await $("btnAdminRefresh").onclick();
    log("âœ… Personel eklendi.", "ok");
  }catch(e){
    log("âŒ Personel eklenemedi: " + (e?.message||e), "bad");
  }
};

/*** =========================
 *  Excel (.xlsx)
 *  ========================= */
$("btnXlsx").onclick = ()=>{
  try{
    const rows = adminFilteredList().slice().sort((a,b)=>(a.created_at||"").localeCompare(b.created_at||""));

    const aoa = [["Tarih","Personel","Tur","Not"]];
    for(const r of rows){
      aoa.push([
        fmtTR(r.created_at||""),
        String(r[COL_H_PER]||""),
        String(r[COL_H_TUR]||""),
        String(r[COL_H_NOT]||"")
      ]);
    }

    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Rapor");

    const d = new Date();
    const fn = `personel_takip_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}.xlsx`;
    XLSX.writeFile(wb, fn);

    log(`âœ… Excel indirildi. (SatÄ±r: ${rows.length})`, "ok");
  }catch(e){
    log("âŒ Excel oluÅŸturulamadÄ±: " + (e?.message||e), "bad");
  }
};

/*** =========================
 *  Yedek / Geri YÃ¼kle (JSON)
 *  ========================= */
$("btnBackup").onclick = async ()=>{
  try{
    log("ğŸ§· Yedek hazÄ±rlanÄ±yor...", "");
    const pReq = supa.from(T_PERSONELLER).select(`${COL_P_AD},${COL_P_SIFRE}`).order(COL_P_AD,{ascending:true}).limit(5000);
    const hReq = supa.from(T_HAREKETLER).select(`id,${COL_H_PER},${COL_H_TUR},${COL_H_NOT},created_at`).order("created_at",{ascending:false}).limit(5000);

    const [{data:pd, error:pe},{data:hd, error:he}] = await Promise.all([pReq,hReq]);
    if(pe) throw pe;
    if(he) throw he;

    const backup = {
      exported_at: new Date().toISOString(),
      ref: SUPABASE_REF,
      personeller: Array.isArray(pd)? pd: [],
      hareketler: Array.isArray(hd)? hd: []
    };

    const blob = new Blob([JSON.stringify(backup,null,2)], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `personel_takip_yedek_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    log(`âœ… Yedek indirildi. Personeller: ${backup.personeller.length} â€¢ Hareketler: ${backup.hareketler.length}`, "ok");
  }catch(e){
    log("âŒ Yedek alÄ±namadÄ±: " + (e?.message||e), "bad");
  }
};

$("fileRestore").addEventListener("change", async (ev)=>{
  const f = ev.target.files?.[0];
  ev.target.value = "";
  if(!f) return;

  try{
    const text = await f.text();
    const j = JSON.parse(text);

    const arrP = Array.isArray(j.personeller) ? j.personeller : [];
    const arrH = Array.isArray(j.hareketler) ? j.hareketler : [];

    // mevcut veriler (Ã§akÄ±ÅŸma iÃ§in)
    const [{data:pd, error:pe},{data:hd, error:he}] = await Promise.all([
      supa.from(T_PERSONELLER).select(`${COL_P_AD}`).limit(5000),
      supa.from(T_HAREKETLER).select(`${COL_H_PER},${COL_H_TUR},${COL_H_NOT},created_at`).order("created_at",{ascending:false}).limit(5000)
    ]);
    if(pe) throw pe;
    if(he) throw he;

    const existingNames = new Set((pd||[]).map(x=>String(x[COL_P_AD]||"").trim()).filter(Boolean).map(s=>s.toLowerCase()));
    const fp = (r)=> `${r[COL_H_PER]||""}|${r[COL_H_TUR]||""}|${r[COL_H_NOT]||""}|${r.created_at||""}`;
    const existingMoves = new Set((hd||[]).map(fp));

    let pInserted=0,pSkipped=0,pFailed=0;
    let hInserted=0,hSkipped=0,hFailed=0;

    // personeller restore (ad_soyad bazlÄ± skip)
    for(const p of arrP){
      const name = String(p[COL_P_AD] ?? p.ad_soyad ?? p.ad ?? "").trim();
      if(!name) continue;
      const key = name.toLowerCase();
      if(existingNames.has(key)){ pSkipped++; continue; }

      const row = {};
      row[COL_P_AD] = name;
      row[COL_P_SIFRE] = (p[COL_P_SIFRE] ?? p.sifre ?? null) || null;

      const { error } = await supa.from(T_PERSONELLER).insert(row);
      if(error){ pFailed++; }
      else{ existingNames.add(key); pInserted++; }
    }

    // hareketler restore (fingerprint skip) â€” id gÃ¶ndermiyoruz!
    for(const h of arrH){
      const per = String(h[COL_H_PER] ?? h.personel_id ?? h.personel ?? "").trim();
      const tur = String(h[COL_H_TUR] ?? h.tur ?? "not").trim() || "not";
      const nt  = String(h[COL_H_NOT] ?? h.not_text ?? h.not ?? "").trim();
      const ca  = h.created_at || null;

      if(!per || !nt || !ca){ continue; }

      const row = {};
      row[COL_H_PER] = per;
      row[COL_H_TUR] = tur;
      row[COL_H_NOT] = nt;
      row.created_at = ca;

      const fpk = fp(row);
      if(existingMoves.has(fpk)){ hSkipped++; continue; }

      const { error } = await supa.from(T_HAREKETLER).insert(row);
      if(error){ hFailed++; }
      else{ existingMoves.add(fpk); hInserted++; }
    }

    $("restoreReport").textContent =
      `Geri YÃ¼kleme Raporu â†’ Personeller: toplam ${arrP.length} / eklenen ${pInserted} / atlanan ${pSkipped} / hata ${pFailed} â€¢ `+
      `Hareketler: toplam ${arrH.length} / eklenen ${hInserted} / atlanan ${hSkipped} / hata ${hFailed}`;

    await $("btnAdminRefresh").onclick();
    log("âœ… Geri yÃ¼kleme bitti. Rapor aÅŸaÄŸÄ±da.", "ok");
  }catch(e){
    log("âŒ Geri yÃ¼kleme baÅŸarÄ±sÄ±z: " + (e?.message||e), "bad");
  }
});

/*** =========================
 *  Ä°lk yÃ¼kleme
 *  ========================= */
(function init(){
  // Personel adÄ± varsa ilk render
  renderPersonel();
  syncAdminUiState();

  // BaÄŸlantÄ± durum etiketi (elle kontrol edilene kadar)
  $("connState").textContent = "Kontrol edilmedi";
  log("HazÄ±r. Ä°stersen Ã¶nce â€œBaÄŸlantÄ±yÄ± Kontrol Etâ€, sonra test.", "");

  // Admin sekmesine geÃ§ince otomatik yenileme yapmayalÄ±m (trafik dÃ¼ÅŸÃ¼k kalsÄ±n)
})();
</script>

</body>
</html>

