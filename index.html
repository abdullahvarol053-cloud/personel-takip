<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personel Takip - Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; padding:20px; }
.card { background:#fff; padding:16px; border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,0.05); margin-bottom:14px; }
input, button { border-radius:12px; padding:10px; border:1px solid #d1d5db; }
button.primary { background:#2563eb; color:#fff; border:none; cursor:pointer; }
button.danger { background:#dc2626; color:#fff; border:none; cursor:pointer; }
#summaryBox { background:#fafafa; border:1px dashed #d1d5db; padding:10px; border-radius:12px; margin-top:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border-bottom:1px solid #e5e7eb; padding:8px; font-size:14px; }
th { background:#f9fafb; text-align:left; }
</style>
</head>
<body>

<h2>ðŸ“Š Personel Takip - Admin Panel</h2>

<div class="card">

<div style="display:flex; flex-wrap:wrap; gap:10px; align-items:end;">
  <div>
    <label>BaÅŸlangÄ±Ã§</label><br>
    <input type="date" id="dtStart">
  </div>

  <div>
    <label>BitiÅŸ</label><br>
    <input type="date" id="dtEnd">
  </div>

  <button class="primary" id="btnFilter">Filtrele</button>
  <button id="btnClear">Temizle</button>

  <div style="margin-left:auto;">
    <button class="primary" id="btnBackup">ðŸ’¾ Yedek</button>
    <button class="danger" id="btnRestore">ðŸ“‚ Geri YÃ¼kle</button>
    <input type="file" id="fileRestore" accept=".json" hidden>
  </div>
</div>

<div id="summaryBox">
  <b>Ã–zet</b> â€”
  GiriÅŸ: <b id="sumIn">0</b> Â·
  Ã‡Ä±kÄ±ÅŸ: <b id="sumOut">0</b> Â·
  Ä°zin: <b id="sumLeave">0</b> Â·
  Not: <b id="sumNote">0</b>
</div>

</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Tarih</th>
        <th>Saat</th>
        <th>Personel</th>
        <th>TÃ¼r</th>
        <th>Not</th>
      </tr>
    </thead>
    <tbody id="dataTable">
      <tr><td colspan="5" style="text-align:center;">YÃ¼kleniyor...</td></tr>
    </tbody>
  </table>
</div>

<script>

const SUPABASE_URL = "https://ngnpocqaznpuggsvwbif.supabase.co";
const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

function getToday() {
  return new Date().toISOString().split("T")[0];
}

window.addEventListener("load", async () => {
  const today = getToday();
  dtStart.value = today;
  dtEnd.value = today;
  await loadData(today, today);
});

async function loadData(start, end) {

  const { data, error } = await supabaseClient
    .from("hareketler")
    .select("*")
    .gte("created_at", start + " 00:00:00")
    .lte("created_at", end + " 23:59:59")
    .order("created_at", { ascending:false });

  if (error) {
    dataTable.innerHTML =
      `<tr><td colspan="5" style="text-align:center;color:red;">Veri Ã§ekme hatasÄ±</td></tr>`;
    return;
  }

  renderTable(data || []);
  calculateSummary(data || []);
}

function renderTable(data) {
  dataTable.innerHTML = "";

  if (!data.length) {
    dataTable.innerHTML =
      `<tr><td colspan="5" style="text-align:center;">Veri yok</td></tr>`;
    return;
  }

  data.forEach(item => {

    const tarih = new Date(item.created_at).toISOString().split("T")[0];
    const saat = new Date(item.created_at).toTimeString().split(" ")[0];

    dataTable.innerHTML += `
      <tr>
        <td>${tarih}</td>
        <td>${saat}</td>
        <td>${item.personel_id}</td>
        <td>${item.tur}</td>
        <td>${item.not_text || ""}</td>
      </tr>
    `;
  });
}

function calculateSummary(data) {
  let giris=0, cikis=0, izin=0, not=0;

  data.forEach(item=>{
    if(item.tur==="giris") giris++;
    if(item.tur==="cikis") cikis++;
    if(item.tur==="izin") izin++;
    if(item.tur==="not") not++;
  });

  sumIn.innerText = giris;
  sumOut.innerText = cikis;
  sumLeave.innerText = izin;
  sumNote.innerText = not;
}

btnFilter.addEventListener("click", async ()=>{
  if(!dtStart.value || !dtEnd.value) return alert("Tarih seÃ§");
  await loadData(dtStart.value, dtEnd.value);
});

btnClear.addEventListener("click", async ()=>{
  const today = getToday();
  dtStart.value = today;
  dtEnd.value = today;
  await loadData(today,today);
});

// BACKUP
btnBackup.addEventListener("click", async ()=>{

  const { data } = await supabaseClient
    .from("hareketler")
    .select("*");

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "personel_yedek.json";
  a.click();

  URL.revokeObjectURL(url);
});

// RESTORE
btnRestore.addEventListener("click", ()=>{
  fileRestore.click();
});

fileRestore.addEventListener("change", async (e)=>{

  if(!confirm("TÃ¼m veriler silinecek. Emin misin?")) return;

  const file = e.target.files[0];
  if(!file) return;

  const text = await file.text();
  const json = JSON.parse(text);

  await supabaseClient.from("hareketler").delete().neq("id",0);
  await supabaseClient.from("hareketler").insert(json);

  const today = getToday();
  await loadData(today,today);
});

</script>
</body>
</html>
