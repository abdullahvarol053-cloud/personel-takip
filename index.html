<!-- FINAL temizleme yap -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personel Takip (FINAL - Beyaz - Şifre HTML'de)</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --txt:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);
      --btn:#2563eb;
      --btn2:#eef2ff;
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:14px;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);border-bottom:1px solid var(--line);backdrop-filter:blur(10px)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    h1{margin:0;font-size:16px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;background:rgba(15,23,42,.02)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--card),#fbfcff);border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid rgba(15,23,42,.14);
      background:#fff;color:var(--txt);outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    textarea{min-height:88px;resize:vertical}
    .btn{border:0;cursor:pointer;padding:10px 12px;border-radius:12px;color:white;background:var(--btn);font-weight:800;font-size:13px}
    .btn.secondary{background:var(--btn2);border:1px solid rgba(37,99,235,.20);color:#1e40af}
    .btn.danger{background:var(--danger)}
    .btn.ok{background:var(--ok)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .mini{font-size:12px;padding:8px 10px;border-radius:10px}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);font-size:12px;vertical-align:top}
    .table th{font-weight:900;background:rgba(15,23,42,.03);text-align:left}
    .table tr:hover td{background:rgba(37,99,235,.04)}
    .right{text-align:right}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);background:rgba(15,23,42,.02)}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--danger)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:14px;
      box-shadow:0 18px 60px rgba(15,23,42,.15);display:none;max-width:min(92vw,780px);z-index:99
    }
    .toast.show{display:block}
    .toast b{font-size:13px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid var(--line);background:rgba(15,23,42,.02);color:#0f172a}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.two{grid-template-columns:1fr}}
    .hide{display:none!important}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(15,23,42,.25);
      display:none;align-items:flex-start;justify-content:center;padding-top:80px;z-index:90
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(720px,92vw);
      background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 70px rgba(15,23,42,.2);
      padding:12px
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>Personel Takip</h1>
      <span class="pill" id="statusPill">Durum: —</span>
      <span class="pill">Limit: <b id="limitPill">5000</b></span>
      <div class="spacer"></div>
      <button class="btn secondary mini" id="btnSync">Sunucudan Senkronize Et</button>
      <button class="btn secondary mini" id="btnAdmin">Admin</button>
    </div>

    <div class="row" style="margin-top:8px">
      <span class="muted">
        Arama: <span class="kbd">personel</span> + <span class="kbd">not</span> |
        Tarih: <span class="kbd">başlangıç</span>–<span class="kbd">bitiş</span> (gün sonu dahil)
      </span>
      <div class="spacer"></div>
      <span class="muted" id="colsInfo">Kolonlar: hareket(created_at/tur/not_text) personel(ad_soyad)</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="card">
      <h2>Yeni Hareket</h2>

      <div class="two">
        <div>
          <label>Personel</label>
          <select id="selPersonel"></select>
          <div class="muted" style="margin-top:6px">Personel yoksa Admin’den ekleyin.</div>
        </div>
        <div>
          <label>Tarih / Saat</label>
          <input id="inpDT" type="datetime-local" />
          <div class="muted" style="margin-top:6px">Boş bırakırsan “şimdi” kaydeder.</div>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Tür</label>
          <select id="selTur">
            <option value="giris">Giriş</option>
            <option value="cikis">Çıkış</option>
            <option value="not">Not</option>
          </select>
        </div>
        <div>
          <label>Etiket (opsiyonel)</label>
          <input id="inpEtiket" placeholder="örn: Servis / Geç / İzin" />
          <div class="muted" style="margin-top:6px">Etiket not içine eklenir.</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Not (opsiyonel)</label>
        <textarea id="inpNot" placeholder="Bu not aramada çıkar (personel + not)."></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnKaydet">Kaydet</button>
        <button class="btn secondary" id="btnTemizle">Temizle</button>
        <div class="spacer"></div>
        <span class="tag" id="liveTag"><span class="dot warn"></span>Bekliyor</span>
      </div>

      <div class="hr"></div>

      <h2>Liste / Filtre</h2>

      <div class="two">
        <div>
          <label>Arama (personel adı + not içinde)</label>
          <input id="inpAra" placeholder="örn: süleyman / geç kaldı / izin" />
        </div>
        <div>
          <label>Personel seç (opsiyonel)</label>
          <select id="selFilterPersonel"></select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Başlangıç (gün başı)</label>
          <input id="inpStart" type="date" />
        </div>
        <div>
          <label>Bitiş (gün sonu dahil)</label>
          <input id="inpEnd" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnUygula">Uygula</button>
        <button class="btn secondary" id="btnSifirla">Sıfırla</button>
        <div class="spacer"></div>
        <button class="btn secondary" id="btnExport">Excel (XLSX) Dışa Ver</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Not: Listeleme ve export maksimum <b>5000</b> kayıt çeker (trafik düşük).
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h2 style="margin:0">Hareketler</h2>
        <div class="spacer"></div>
        <span class="pill" id="countPill">0 kayıt</span>
      </div>

      <div style="margin-top:10px; overflow:auto; max-height:65vh">
        <table class="table">
          <thead>
            <tr>
              <th style="min-width:140px">Tarih</th>
              <th style="min-width:150px">Personel</th>
              <th style="min-width:90px">Tür</th>
              <th>Not</th>
              <th class="right" style="min-width:110px">İşlem</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn secondary mini" id="btnPrev">← Önceki</button>
        <button class="btn secondary mini" id="btnNext">Sonraki →</button>
        <div class="spacer"></div>
        <span class="muted">Sayfa: <b id="pageInfo">1</b></span>
      </div>
    </section>

  </div>
</main>

<!-- ADMIN MODAL -->
<div class="modalBack" id="adminBack">
  <div class="modal">
    <div class="row">
      <b>Admin</b>
      <div class="spacer"></div>
      <button class="btn secondary mini" id="btnAdminClose">Kapat</button>
    </div>
    <div class="muted" style="margin-top:6px">PIN ile giriş. (PIN HTML içinde, Ctrl+F: <span class="kbd">ADMIN_PIN</span>)</div>

    <div class="hr"></div>

    <div id="adminLocked">
      <label>Admin PIN</label>
      <input id="adminPin" type="password" placeholder="••••••" />
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnAdminLogin">Giriş</button>
        <span class="muted">Yanlış deneme: <b id="pinTry">0</b></span>
        <div class="spacer"></div>
        <span class="muted" id="lockInfo">—</span>
      </div>
    </div>

    <div id="adminUnlocked" class="hide">
      <div class="row">
        <span class="tag"><span class="dot ok"></span>Admin aktif</span>
        <div class="spacer"></div>
        <button class="btn secondary mini" id="btnAdminLogout">Çıkış</button>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px; font-size:13px">Personel Yönetimi</h3>
      <div class="two">
        <div>
          <label>Yeni personel adı</label>
          <input id="inpNewPersonel" placeholder="örn: Süleyman" />
        </div>
        <div style="display:flex; gap:10px; align-items:flex-end">
          <button class="btn ok" id="btnAddPersonel" style="width:100%">Ekle</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn danger mini" id="btnDelPersonel">Seçili personeli sil</button>
        <span class="muted">FK varsa Supabase engeller.</span>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px; font-size:13px">Yedek / Geri Yükle</h3>
      <div class="row">
        <button class="btn secondary mini" id="btnBackup">JSON İndir</button>
        <label class="btn secondary mini" style="cursor:pointer; display:inline-flex; align-items:center; gap:8px">
          JSON Yükle
          <input id="fileRestore" type="file" accept="application/json" style="display:none" />
        </label>
        <div class="spacer"></div>
        <span class="muted" id="restoreReport">—</span>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px; font-size:13px">Kayıt Silme</h3>
      <div class="row">
        <button class="btn danger mini" id="btnDeleteRow">Seçili satırı sil</button>
        <span class="muted">Listeden “Seç” → sonra buradan sil.</span>
      </div>
    </div>

  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <b id="toastTitle">—</b>
  <div class="muted" id="toastMsg">—</div>
</div>

<script>
/* =========================
   AYARLAR (BUNLAR KOLAY)
========================= */
const LIMIT = 5000;
const PAGE_SIZE = 100;

/* ✅ Admin şifresi burada: Ctrl+F -> ADMIN_PIN */
const ADMIN_PIN = "32";

/* ✅ Supabase Config (DOLDUR) */
const SUPABASE_URL  = "https://ngnpocqaznpuggsvwbif.supabase.co
";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbnBvY3Fhem5wdWdnc3Z3YmlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDIzNzksImV4cCI6MjA4NjI3ODM3OX0.a2bCf0CfV7Vur6z60Q9O1nBXVdsCPHL3KJTBiEmbpec
";

/* ✅ Tablo/kolonlar (SENDE BÖYLE) */
const TBL_PERSONEL = "personeller";
const TBL_HAREKET  = "hareketler";

const COL_PERSONEL_ID   = "id";
const COL_PERSONEL_NAME = "ad_soyad";

const COL_H_ID    = "id";
const COL_H_PID   = "personel_id";
const COL_H_DATE  = "created_at";
const COL_H_TUR   = "tur";
const COL_H_NOTE  = "not_text";

/* ========================= */
const STORAGE = {
  ADMIN_OK: "PT_ADMIN_OK_SESSION",
  ADMIN_TRY: "PT_ADMIN_TRY",
  ADMIN_LOCK_UNTIL: "PT_ADMIN_LOCK_UNTIL",
  LAST_FILTERS: "PT_LAST_FILTERS"
};

let supa = null;
let personeller = [];
let hareketler = [];
let page = 1;
let selectedRowId = null;

const $ = (id)=>document.getElementById(id);

function toast(title,msg){
  $("toastTitle").textContent = title || "Bilgi";
  $("toastMsg").textContent = msg || "";
  $("toast").classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> $("toast").classList.remove("show"), 2600);
}

function setStatus(text, ok=true){
  $("statusPill").textContent = "Durum: " + text;
  $("liveTag").innerHTML = ok ? `<span class="dot ok"></span>Bağlı` : `<span class="dot warn"></span>${text}`;
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function fmtDT(iso){
  try{
    const d = new Date(iso);
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{ return iso || ""; }
}

function startOfDayISO(dateStr){
  if(!dateStr) return null;
  return new Date(dateStr + "T00:00:00").toISOString();
}
function endOfDayISO(dateStr){
  if(!dateStr) return null;
  return new Date(dateStr + "T23:59:59.999").toISOString();
}

/* =========================
   ADMIN (ŞİFRE HTML'DE)
========================= */
function adminLockedUntil(){
  const t = Number(localStorage.getItem(STORAGE.ADMIN_LOCK_UNTIL) || "0");
  return t;
}
function isLocked(){
  const until = adminLockedUntil();
  return until && Date.now() < until;
}
function lockInfoText(){
  const until = adminLockedUntil();
  if(!until) return "—";
  if(Date.now() >= until) return "—";
  const d = new Date(until);
  return "Kilitli: " + d.toLocaleString("tr-TR");
}
function getTry(){
  return Number(localStorage.getItem(STORAGE.ADMIN_TRY) || "0");
}
function setTry(n){
  localStorage.setItem(STORAGE.ADMIN_TRY, String(n));
  $("pinTry").textContent = String(n);
}
function setLock(msFromNow){
  localStorage.setItem(STORAGE.ADMIN_LOCK_UNTIL, String(Date.now() + msFromNow));
  $("lockInfo").textContent = lockInfoText();
}
function clearLock(){
  localStorage.removeItem(STORAGE.ADMIN_LOCK_UNTIL);
  $("lockInfo").textContent = "—";
}

function isAdmin(){
  return sessionStorage.getItem(STORAGE.ADMIN_OK) === "1";
}
function setAdmin(on){
  if(on) sessionStorage.setItem(STORAGE.ADMIN_OK, "1");
  else sessionStorage.removeItem(STORAGE.ADMIN_OK);
}

function openAdmin(show){
  const back = $("adminBack");
  if(show){
    back.classList.add("show");
    $("lockInfo").textContent = lockInfoText();

    const ok = isAdmin();
    $("adminLocked").classList.toggle("hide", ok);
    $("adminUnlocked").classList.toggle("hide", !ok);

    $("pinTry").textContent = String(getTry());
  }else{
    back.classList.remove("show");
  }
}

function adminLogin(){
  $("lockInfo").textContent = lockInfoText();

  if(isLocked()){
    toast("Admin", "Çok deneme oldu. Şu an kilitli.");
    return;
  }

  const pin = ($("adminPin").value || "").trim();
  if(pin === ADMIN_PIN){
    setAdmin(true);
    $("adminPin").value = "";
    setTry(0);
    clearLock();
    toast("Admin", "Giriş başarılı ✅");
    openAdmin(true);
    renderTable(); // butonlar admin oldu
  }else{
    const t = getTry() + 1;
    setTry(t);
    toast("Admin", "PIN yanlış.");

    // 5 yanlış -> 24 saat kilit
    if(t >= 5){
      setLock(24 * 60 * 60 * 1000);
      toast("Admin", "5 yanlış deneme. 24 saat kilitlendi.");
    }
  }
}

function adminLogout(){
  setAdmin(false);
  toast("Admin", "Çıkış yapıldı.");
  openAdmin(true);
  renderTable();
}

/* =========================
   VERİ
========================= */
function saveFiltersToStorage(){
  const f = {
    q: $("inpAra").value.trim(),
    p: $("selFilterPersonel").value || "",
    start: $("inpStart").value || "",
    end: $("inpEnd").value || ""
  };
  localStorage.setItem(STORAGE.LAST_FILTERS, JSON.stringify(f));
}

function loadFiltersFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE.LAST_FILTERS);
    if(!raw) return;
    const f = JSON.parse(raw);
    $("inpAra").value = f.q || "";
    $("inpStart").value = f.start || "";
    $("inpEnd").value = f.end || "";
  }catch{}
}

function fillPersonelSelects(){
  const optBase = [];
  const optFilter = [`<option value="">(Hepsi)</option>`];

  if(!personeller.length){
    optBase.push(`<option value="" disabled selected>Personel yok</option>`);
    optFilter.push(`<option value="" disabled>Personel yok</option>`);
  }else{
    for(const p of personeller){
      const id = p[COL_PERSONEL_ID];
      const name = (p[COL_PERSONEL_NAME] || "").trim();
      const label = name ? name : id;
      optBase.push(`<option value="${escapeHtml(String(id))}">${escapeHtml(label)}</option>`);
      optFilter.push(`<option value="${escapeHtml(String(id))}">${escapeHtml(label)}</option>`);
    }
  }

  $("selPersonel").innerHTML = optBase.join("");
  $("selFilterPersonel").innerHTML = optFilter.join("");

  // eski seçimi geri bas
  try{
    const f = JSON.parse(localStorage.getItem(STORAGE.LAST_FILTERS) || "{}");
    if(f.p) $("selFilterPersonel").value = f.p;
  }catch{}
}

async function loadPersoneller(){
  const { data, error } = await supa.from(TBL_PERSONEL).select("*").order(COL_PERSONEL_NAME, { ascending:true }).limit(LIMIT);
  if(error) throw error;
  personeller = data || [];
  fillPersonelSelects();
}

async function loadHareketler(){
  const q = ($("inpAra").value || "").trim().toLowerCase();
  const pidFilter = $("selFilterPersonel").value || "";
  const start = $("inpStart").value;
  const end = $("inpEnd").value;

  let query = supa.from(TBL_HAREKET).select("*").limit(LIMIT).order(COL_H_DATE, {ascending:false});

  const sIso = startOfDayISO(start);
  const eIso = endOfDayISO(end);
  if(sIso) query = query.gte(COL_H_DATE, sIso);
  if(eIso) query = query.lte(COL_H_DATE, eIso);
  if(pidFilter) query = query.eq(COL_H_PID, pidFilter);

  const { data, error } = await query;
  if(error) throw error;

  const raw = data || [];

  // personel id->ad
  const pmap = new Map(personeller.map(p => [p[COL_PERSONEL_ID], (p[COL_PERSONEL_NAME]||"").trim()]));

  // arama: personel adı + not + tür
  hareketler = q ? raw.filter(r=>{
    const pid = r[COL_H_PID];
    const ad = (pmap.get(pid) || "").toLowerCase();
    const note = ((r[COL_H_NOTE] || "") + "").toLowerCase();
    const tur  = ((r[COL_H_TUR]  || "") + "").toLowerCase();
    return ad.includes(q) || note.includes(q) || tur.includes(q);
  }) : raw;

  $("countPill").textContent = `${hareketler.length} kayıt`;
}

function renderTable(){
  const pmap = new Map(personeller.map(p => [p[COL_PERSONEL_ID], (p[COL_PERSONEL_NAME]||"").trim()]));
  const total = hareketler.length;
  const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(page > maxPage) page = maxPage;
  $("pageInfo").textContent = `${page} / ${maxPage}`;

  const startIdx = (page-1) * PAGE_SIZE;
  const slice = hareketler.slice(startIdx, startIdx + PAGE_SIZE);

  const canAdmin = isAdmin();

  const html = slice.map(r=>{
    const id = r[COL_H_ID];
    const pid = r[COL_H_PID];
    const ad = pmap.get(pid) || pid || "—";
    const tur = r[COL_H_TUR] || "—";
    const note = r[COL_H_NOTE] || "";
    const dt = r[COL_H_DATE] || "";

    const btns = canAdmin
      ? `<button class="btn secondary mini" onclick="window.__pickRow('${escapeHtml(String(id))}')">Seç</button>
         <button class="btn danger mini" onclick="window.__deleteRow('${escapeHtml(String(id))}')">Sil</button>`
      : `<button class="btn secondary mini" disabled>Seç</button>
         <button class="btn danger mini" disabled>Sil</button>`;

    return `
      <tr data-id="${escapeHtml(String(id))}">
        <td>${escapeHtml(fmtDT(dt))}</td>
        <td>${escapeHtml(ad)}</td>
        <td>${escapeHtml(String(tur))}</td>
        <td>${escapeHtml(String(note))}</td>
        <td class="right">${btns}</td>
      </tr>
    `;
  }).join("");

  $("tbody").innerHTML = html || `<tr><td colspan="5" class="muted">Kayıt yok.</td></tr>`;
}

window.__pickRow = (id)=>{
  selectedRowId = id;
  toast("Seçildi", "Satır seçildi ✅");
};

window.__deleteRow = async (id)=>{
  if(!isAdmin()) return toast("Yetki", "Silmek için Admin girişi gerekli.");
  await deleteRow(id);
};

async function deleteRow(id){
  if(!confirm("Bu satır silinsin mi?")) return;
  const { error } = await supa.from(TBL_HAREKET).delete().eq(COL_H_ID, id);
  if(error) return toast("Hata", error.message);
  toast("Sil", "Silindi ✅");
  selectedRowId = null;
  await refreshAll(true);
}

/* =========================
   KAYDET / FORM
========================= */
function clearForm(){
  $("inpDT").value = "";
  $("selTur").value = "giris";
  $("inpEtiket").value = "";
  $("inpNot").value = "";
}

async function saveHareket(){
  const pid = $("selPersonel").value;
  if(!pid) return toast("Eksik", "Personel seç.");

  const dt = $("inpDT").value;
  const iso = dt ? new Date(dt).toISOString() : new Date().toISOString();

  const tur = $("selTur").value;
  const etiket = ($("inpEtiket").value || "").trim();
  const noteRaw = ($("inpNot").value || "").trim();
  const note = (etiket ? ("#" + etiket + " ") : "") + (noteRaw || "");

  const payload = {
    [COL_H_PID]: pid,
    [COL_H_DATE]: iso,
    [COL_H_TUR]: tur,
    [COL_H_NOTE]: note || null
  };

  $("btnKaydet").disabled = true;
  try{
    const { error } = await supa.from(TBL_HAREKET).insert(payload);
    if(error) throw error;
    toast("Kayıt", "Kaydedildi ✅");
    clearForm();
    await refreshAll(true);
  }catch(e){
    toast("Hata", e.message || String(e));
    setStatus("Kayıt hatası", false);
  }finally{
    $("btnKaydet").disabled = false;
  }
}

/* =========================
   ADMIN: PERSONEL
========================= */
async function addPersonel(){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  const name = ($("inpNewPersonel").value || "").trim();
  if(!name) return toast("Eksik", "Personel adı yaz.");

  const { error } = await supa.from(TBL_PERSONEL).insert({ [COL_PERSONEL_NAME]: name });
  if(error) return toast("Hata", error.message);

  $("inpNewPersonel").value = "";
  toast("Personel", "Eklendi ✅");
  await refreshAll(true);
}

async function delSelectedPersonel(){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  const pid = $("selPersonel").value;
  if(!pid) return toast("Eksik", "Silmek için personel seç.");

  if(!confirm("Seçili personel silinsin mi?")) return;

  const { error } = await supa.from(TBL_PERSONEL).delete().eq(COL_PERSONEL_ID, pid);
  if(error) return toast("Hata", error.message);

  toast("Personel", "Silindi ✅");
  await refreshAll(true);
}

/* =========================
   YEDEK / GERİ YÜKLE
========================= */
async function backupJSON(){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");

  try{
    const { data: p, error: ep } = await supa.from(TBL_PERSONEL).select("*").limit(LIMIT);
    if(ep) throw ep;

    const { data: h, error: eh } = await supa.from(TBL_HAREKET).select("*").limit(LIMIT);
    if(eh) throw eh;

    // hareketlere personel adı da ekleyelim (geri yüklemede kolay)
    const pmap = new Map((p||[]).map(x => [x[COL_PERSONEL_ID], (x[COL_PERSONEL_NAME]||"").trim()]));
    const h2 = (h||[]).map(r => ({
      id: r[COL_H_ID],
      created_at: r[COL_H_DATE],
      tur: r[COL_H_TUR],
      not_text: r[COL_H_NOTE],
      personel_id: r[COL_H_PID],
      personel_ad: pmap.get(r[COL_H_PID]) || ""
    }));

    const out = {
      meta: { createdAt: new Date().toISOString(), limit: LIMIT },
      personeller: (p||[]).map(x => ({ id: x[COL_PERSONEL_ID], ad_soyad: x[COL_PERSONEL_NAME] })),
      hareketler: h2
    };

    const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "personel_takip_yedek_" + new Date().toISOString().slice(0,10) + ".json";
    a.click();
    toast("Yedek", "JSON indirildi ✅");
  }catch(e){
    toast("Hata", e.message || String(e));
  }
}

async function restoreJSON(evt){
  if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
  const file = evt.target.files?.[0];
  evt.target.value = "";
  if(!file) return;

  try{
    const json = JSON.parse(await file.text());
    const p = Array.isArray(json.personeller) ? json.personeller : [];
    const h = Array.isArray(json.hareketler) ? json.hareketler : [];

    // mevcut personelleri çek
    await loadPersoneller();
    const byName = new Map(personeller.map(x => [((x[COL_PERSONEL_NAME]||"").trim().toLowerCase()), x[COL_PERSONEL_ID]]));

    let okP=0, skipP=0, okH=0, skipH=0;

    // personel ekle (adı yoksa atla)
    for(const item of p){
      const name = (item.ad_soyad || "").trim();
      if(!name){ skipP++; continue; }

      const key = name.toLowerCase();
      if(byName.has(key)){ skipP++; continue; }

      const { error } = await supa.from(TBL_PERSONEL).insert({ [COL_PERSONEL_NAME]: name });
      if(error){ skipP++; }
      else { okP++; }

      if(okP + skipP >= LIMIT) break;
    }

    // tekrar çek ve map güncelle
    await loadPersoneller();
    const byName2 = new Map(personeller.map(x => [((x[COL_PERSONEL_NAME]||"").trim().toLowerCase()), x[COL_PERSONEL_ID]]));

    // hareket ekle (id göndermeden insert)
    for(const item of h){
      let pid = item.personel_id || null;
      const ad = (item.personel_ad || "").trim().toLowerCase();

      if(!pid && ad && byName2.has(ad)) pid = byName2.get(ad);
      if(!pid){ skipH++; continue; }

      const payload = {
        [COL_H_PID]: pid,
        [COL_H_DATE]: item.created_at || new Date().toISOString(),
        [COL_H_TUR]: item.tur || "not",
        [COL_H_NOTE]: item.not_text || null
      };

      const { error } = await supa.from(TBL_HAREKET).insert(payload);
      if(error){ skipH++; }
      else { okH++; }

      if(okH + skipH >= LIMIT) break;
    }

    $("restoreReport").textContent = `Personel: +${okP} (atla:${skipP}) | Hareket: +${okH} (atla:${skipH})`;
    toast("Geri Yükle", "Bitti ✅");
    await refreshAll(true);
  }catch(e){
    toast("Hata", e.message || String(e));
  }
}

/* =========================
   EXCEL
========================= */
function exportXLSX(){
  if(!hareketler.length) return toast("Excel", "Kayıt yok.");

  const pmap = new Map(personeller.map(p => [p[COL_PERSONEL_ID], (p[COL_PERSONEL_NAME]||"").trim()]));

  const data = hareketler.slice(0, LIMIT).map(r => ({
    "Tarih": fmtDT(r[COL_H_DATE]),
    "Personel": pmap.get(r[COL_H_PID]) || r[COL_H_PID] || "",
    "Tür": r[COL_H_TUR] || "",
    "Not": r[COL_H_NOTE] || ""
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Hareketler");
  XLSX.writeFile(wb, "personel_hareketleri_" + new Date().toISOString().slice(0,10) + ".xlsx");
  toast("Excel", "XLSX indirildi ✅");
}

/* =========================
   REFRESH
========================= */
async function refreshAll(showToast){
  saveFiltersToStorage();

  $("btnSync").disabled = true;
  $("btnUygula").disabled = true;
  $("btnSifirla").disabled = true;

  try{
    await loadPersoneller();
    await loadHareketler();
    renderTable();
    setStatus("Hazır", true);
    if(showToast) toast("Senkron", "Güncellendi ✅");
  }catch(e){
    setStatus("Hata", false);
    toast("Hata", e.message || String(e));
  }finally{
    $("btnSync").disabled = false;
    $("btnUygula").disabled = false;
    $("btnSifirla").disabled = false;
  }
}

/* =========================
   EVENTS + INIT
========================= */
function wire(){
  $("limitPill").textContent = String(LIMIT);

  $("btnKaydet").addEventListener("click", saveHareket);
  $("btnTemizle").addEventListener("click", clearForm);

  $("btnUygula").addEventListener("click", async()=>{ page=1; await refreshAll(false); });
  $("btnSifirla").addEventListener("click", async()=>{
    $("inpAra").value = "";
    $("inpStart").value = "";
    $("inpEnd").value = "";
    $("selFilterPersonel").value = "";
    page=1;
    await refreshAll(false);
  });

  $("btnPrev").addEventListener("click", ()=>{ if(page>1){ page--; renderTable(); } });
  $("btnNext").addEventListener("click", ()=>{
    const maxPage = Math.max(1, Math.ceil(hareketler.length / PAGE_SIZE));
    if(page < maxPage){ page++; renderTable(); }
  });

  $("btnSync").addEventListener("click", async()=>{ await refreshAll(true); });
  $("btnExport").addEventListener("click", exportXLSX);

  $("btnAdmin").addEventListener("click", ()=>openAdmin(true));
  $("btnAdminClose").addEventListener("click", ()=>openAdmin(false));

  $("btnAdminLogin").addEventListener("click", adminLogin);
  $("btnAdminLogout").addEventListener("click", adminLogout);

  $("btnAddPersonel").addEventListener("click", addPersonel);
  $("btnDelPersonel").addEventListener("click", delSelectedPersonel);

  $("btnBackup").addEventListener("click", backupJSON);
  $("fileRestore").addEventListener("change", restoreJSON);

  $("btnDeleteRow").addEventListener("click", async()=>{
    if(!isAdmin()) return toast("Yetki", "Admin gerekli.");
    if(!selectedRowId) return toast("Sil", "Önce listeden bir satır seç.");
    await deleteRow(selectedRowId);
  });

  $("inpAra").addEventListener("keydown", async(e)=>{
    if(e.key === "Enter"){ page=1; await refreshAll(false); }
  });

  $("tbody").addEventListener("click",(e)=>{
    const tr = e.target.closest("tr"); if(!tr) return;
    selectedRowId = tr.getAttribute("data-id") || null;
  });
}

(async function init(){
  wire();
  loadFiltersFromStorage();

  try{
    if(SUPABASE_URL.includes("YOUR_") || SUPABASE_ANON.includes("YOUR_")){
      setStatus("Supabase ayarı yok", false);
      toast("Ayar", "SUPABASE_URL ve SUPABASE_ANON doldur.");
      return;
    }

    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    setStatus("Bağlantı hazır", true);

    await refreshAll(false);
  }catch(e){
    setStatus("Başlatma hatası", false);
    toast("Hata", e.message || String(e));
  }
})();
</script>
</body>
</html>
